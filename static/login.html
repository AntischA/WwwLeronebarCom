<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wi-Fi prijava</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
           display:flex; flex-direction:column; gap:14px; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
    button, a.btn { padding:14px 18px; border:0; border-radius:12px; font-size:16px; cursor:pointer; text-decoration:none; box-shadow:0 6px 16px rgba(0,0,0,.08); display:inline-block; }
    .muted { color:#666; font-size:14px; text-align:center; max-width:520px; }
  </style>

  <!-- Firebase compat SDK (bez ES modula) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1 style="margin:0">Wi-Fi prijava</h1>
  <p class="muted" id="status">Prijavite se Google računom da biste dobili internet pristup.</p>
  <a href="#" class="btn" id="googleBtn">Prijavi se Google-om</a>
  <a href="#" class="muted" id="openInBrowser" style="text-decoration:underline">Ne radi? Otvori u pregledniku</a>

  <!-- MikroTik forma (skrivena) – ne diraj $(...) varijable -->
  <form id="mikrotikLogin" method="post" action="$(link-login-only)" style="display:none">
    <input type="hidden" name="username" id="mtUser" value="google" />
    <input type="hidden" name="password" id="mtPass" value="google" />
    <input type="hidden" name="dst" value="$(link-orig)" />
    <input type="hidden" name="popup" value="true" />
  </form>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDpihyfvNSSC66e9i5iWAzEu2MnmZPwPLk",
      authDomain: "leronebar-com.firebaseapp.com",
      projectId: "leronebar-com",
      storageBucket: "leronebar-com.appspot.com",
      messagingSenderId: "663579114142",
      appId: "1:663579114142:web:10b1a380cb561395e3198f"
    };

    // Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    const btn = document.getElementById("googleBtn");
    const status = document.getElementById("status");
    const openInBrowser = document.getElementById("openInBrowser");

    // Dugme: redirect (bolje od popup u captive portalima)
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      status.textContent = "Otvaram Google prijavu…";
      auth.signInWithRedirect(provider).catch(err => {
        console.error(err);
        alert("Ne mogu otvoriti Google prijavu: " + (err && err.message ? err.message : err));
      });
    });

    // Link koji korisniku otvara istu stranicu u punom pregledniku (Chrome)
    openInBrowser.addEventListener("click", function (e) {
      e.preventDefault();
      // pokušaj otvoriti u novom tabu
      window.open(window.location.href, "_blank");
    });

    // Nakon povratka sa Google-a:
    auth.getRedirectResult().then(async (result) => {
      if (!result || !result.user) return;

      status.textContent = "Spajam…";

      // 1) PRVO spoji hotspot (siguran korak)
      document.getElementById("mikrotikLogin").submit();

      // 2) Zatim probaj async evidenciju – ali ne kvari UX ako padne
      try {
        const user = result.user;
        await db.collection("users").doc(user.uid).set({
          uid: user.uid,
          email: user.email || "",
          displayName: user.displayName || "",
          photoURL: user.photoURL || "",
          provider: "google",
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } catch (e) {
        console.warn("Firestore zapis preskočen:", e);
      }

      // 3) Zatvori captive portal (Android očekuje baš HTTP 204)
      setTimeout(function () {
        location.href = "http://connectivitycheck.gstatic.com/generate_204";
      }, 800);
    }).catch(err => {
      console.error(err);
      // umesto “Greška pri prijavi”, daj neutralnu poruku ili ništa
      status.textContent = "Pokušajte ponovno.";
    });
  </script>
</body>
</html>
