<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radnje korisnika</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/radnje_korisnika.css') }}">
</head>
<body>

  <div class="prvired">
      <button id="prev-day">‚Üê Tjedan prije</button>
      <button id="next-day">Tjedan poslije ‚Üí</button>
  </div>

<form id="drugired-form">
  <input type="date" id="from_date" name="from_date" required>
  <input type="date" id="to_date" name="to_date" required>
  <button type="submit">Prika≈æi</button>
</form>




  <!-- Novi red widgeta -->
<ul class="summary-date custom-widgets">
  <li>
    <div class="naziv">Datum</div>
    <div class="iznos"></div>
  </li>
  <li>
    <div class="naziv">Jutro</div>
    <div class="iznos"></div>
  </li>
  <li>
    <div class="naziv">Popodne</div>
    <div class="iznos"></div>
  </li>
  <li>
    <div class="naziv">Ukupno</div>
    <div class="iznos"></div>
  </li>
</ul>



  <div class="summary">
    <ul id="summary-list"></ul>
  </div>





  <p id="loader">Uƒçitavanje podataka...</p>
  <div id="results-container"></div>




  <!-- Footer bar -->
<div class="footer-bar">
  <button id="artikli-button">üì¶ Artikli</button>
  <button id="grafikon-button">üìà Jutro</button>
  <button id="grafikon2-button">üìä Popodne</button>
  <button>Prazno 3</button>
</div>




<!-- Artikli modal -->
<div id="artikli-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="zatvoriModal()">&times;</span>
    <h3>üì¶ Potro≈°nja artikala</h3>
    <ul id="artikli-summary-list"></ul>
  </div>
</div>

<!-- Grafikon modal -->
<div id="grafikon-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="zatvoriGrafikonModal()">&times;</span>
    <canvas id="modal-chart06_15"></canvas>
  </div>
</div>

<!-- Grafikon 2 modal -->
<div id="grafikon2-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="zatvoriGrafikon2Modal()">&times;</span>
    <canvas id="modal-chart15_01_b"></canvas>
  </div>
</div>









 <script>
let potrosnjaArtikalaPoDanuGlobal = null;
let sviDatumiGlobal = [];
let potrosnjaArtikalaGlobal = null;

let resultNaplatePoSatu = null;
let aktivniFilteri = new Set();

// ‚¨áÔ∏è NOVO: globalne mape po danu i satu
let naplataStolaPoSatuGlobal = {};
let naStolPoSatuGlobal = {};

const nazivMap = {
    "Dodavanje na stol": "Na stol",
    "Otkazivanje narud≈æbe": "Otkaz stola"
};

  function formatDateToInput(date) {
    return date.toISOString().split("T")[0];
  }

  function formatDateForBackend(date) {
    return date.split("-").reverse().join(".");
  }

  function parseDateInput(inputId) {
    return new Date(document.getElementById(inputId).value);
  }




async function fetchData() {
    resetPrikaz();

    const { fromDate, toDate } = getDateRange();
    const result = await dohvatiPodatkeSaServera(fromDate, toDate);
    if (!result) return;
    potrosnjaArtikalaPoDanuGlobal = result.potrosnja_artikala_po_danu || null;
    potrosnjaArtikalaGlobal = result.potrosnja_artikala || null;

    prikaziPodatkePoDatumima(result.data_po_datumima);
    prikaziPotrosnjuArtikala(result.potrosnja_artikala);
    resultNaplatePoSatu = result.naplate_po_satu;
    prikaziGrafikone(resultNaplatePoSatu);
}

function getDateRange() {
    const fromDateInput = document.getElementById("from_date").value;
    const toDateInput = document.getElementById("to_date").value;

    return {
        fromDate: formatDateForBackend(fromDateInput),
        toDate: formatDateForBackend(toDateInput)
    };
}

async function dohvatiPodatkeSaServera(fromDate, toDate) {
    const loader = document.getElementById("loader");
    loader.style.display = "block";

    try {
        const response = await fetch("/api/radnje_korisnika", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ from_date: fromDate, to_date: toDate })
        });

        const result = await response.json();
        loader.style.display = "none";

        if (!(result.success && result.data_po_datumima && Object.keys(result.data_po_datumima).length > 0)) {
            prikaziPorukuBezPodataka();
            return null;
        }

        return result;
    } catch (err) {
        console.error("Gre≈°ka kod dohvata podataka:", err);
        loader.style.display = "none";
        prikaziPorukuOGresci();
        return null;
    }
}


function resetPrikaz() {
    document.getElementById("artikli-summary-list").innerHTML = "";
    document.getElementById("results-container").innerHTML = "";
    document.getElementById("summary-list").innerHTML = "";
    aktivniFilteri.clear();

    // ‚¨áÔ∏è NOVO:
    naplataStolaPoSatuGlobal = {};
    naStolPoSatuGlobal = {};
}


function sortirajDatume(a, b) {
    const [da, ma, ya] = a.split(".");
    const dateA = new Date(`${ya}-${String(ma).padStart(2, "0")}-${String(da).padStart(2, "0")}`);
    const [db, mb, yb] = b.split(".");
    const dateB = new Date(`${yb}-${String(mb).padStart(2, "0")}-${String(db).padStart(2, "0")}`);
    return dateB - dateA; // od najnovijeg prema starom
}





function pronadiPodatkeNaplate(datum) {
    if (!resultNaplatePoSatu) return null;

    // 1. Poku≈°aj direktno
    if (resultNaplatePoSatu[datum]) return resultNaplatePoSatu[datum];

    // 2. Poku≈°aj bez vodeƒáih nula (01.08.2025 ‚Üí 1.8.2025)
    const parts = datum.split(".");
    if (parts.length >= 3) {
        const dan = parseInt(parts[0], 10);
        const mjesec = parseInt(parts[1], 10);
        const godina = parts[2];
        const bezNula = `${dan}.${mjesec}.${godina}`;
        if (resultNaplatePoSatu[bezNula]) return resultNaplatePoSatu[bezNula];

        // 3. Poku≈°aj u ISO formatu (YYYY-MM-DD)
        const iso = `${godina}-${String(mjesec).padStart(2, "0")}-${String(dan).padStart(2, "0")}`;
        if (resultNaplatePoSatu[iso]) return resultNaplatePoSatu[iso];
    }

    return null; // Ako ni≈°ta nije pronaƒëeno
}


function prikaziPodatkePoDatumima(data_po_datumima) {
    const summaryList = document.getElementById("summary-list");
    const resultsContainer = document.getElementById("results-container");

    const daniUTjednu = ["Nedjelja", "Ponedjeljak", "Utorak", "Srijeda",
        "ƒåetvrtak", "Petak", "Subota"];

    const ignoriraneVrste = [
        "Prijava", "Odjava", "Izlaz iz aplikacije", "ƒåitanje liste totala", "ƒåitanje totala konobara",
        "Prijava, neuspje≈°na", "Ostalo", "Pokretanje aplikacije", "ƒåitanje totala", "Premje≈°tanje stola"
    ];

    let tjedniZbroj = 0;
    let daniPodaci = [];

    const sviDatumi = Object.keys(data_po_datumima).sort(sortirajDatume);
    sviDatumiGlobal = sviDatumi;

    sviDatumi.forEach((datum) => {
        const items = data_po_datumima[datum];
        const totalsByType = {};

        // lokalni zbir po periodima
        let naplataStolaJutro = 0, naplataStolaPopodne = 0;
        let naStolJutro = 0, naStolPopodne = 0;

        const dateSection = document.createElement("div");
        dateSection.classList.add("date-section");

        const dateList = document.createElement("ul");
        dateList.classList.add("summary-date");

        const [dan, mjesec, godina] = datum.split(".");
        const jsDate = new Date(`${godina}-${mjesec}-${dan}`);
        const danUTjednu = daniUTjednu[jsDate.getDay()];
        const formatiraniDatum = `${String(dan).padStart(2, "0")}.${String(mjesec).padStart(2, "0")}.`;

        const dateWidget = document.createElement("li");
        dateWidget.classList.add("date-widget");
        dateWidget.innerHTML = `
            <div class="naziv">${danUTjednu}</div>
            <div class="iznos">${formatiraniDatum}</div>
        `;
        dateList.appendChild(dateWidget);

        const ostaliWrapper = document.createElement("div");
        ostaliWrapper.classList.add("ostali-wrapper");
        ostaliWrapper.style.display = "none";
        ostaliWrapper.style.flexWrap = "wrap";
        ostaliWrapper.style.gap = "8px";

        // Prolaz kroz stavke: punimo kartice + zbirke po periodima
      items.forEach(item => {
          const vrstaNorm = nazivMap[item.vrsta_akcije] || item.vrsta_akcije;
          const iznos = parseFloat(item.iznos.replace(" ‚Ç¨", "").replace(",", ".")) || 0;
          const sat = parseInt(item.vrijeme.split(":")[0], 10);
          const jeJutro = (sat >= 6 && sat <= 15);

          if (vrstaNorm === "Naplata stola") {
              if (jeJutro) naplataStolaJutro += iznos;
              else naplataStolaPopodne += iznos; // 15‚Äì23 i 00h
          }
          if (vrstaNorm === "Na stol") {
              if (jeJutro) naStolJutro += iznos;
              else naStolPopodne += iznos;
          }

          dodajKarticu(resultsContainer, item, totalsByType, datum);
              // ‚¨áÔ∏è NOVO: saberi po SATU (HH) za grafikon
    const satHH = item.vrijeme ? item.vrijeme.split(":")[0].padStart(2, "0") : null;
    if (satHH) {
        if (vrstaNorm === "Naplata stola") {
            if (!naplataStolaPoSatuGlobal[datum]) naplataStolaPoSatuGlobal[datum] = {};
            naplataStolaPoSatuGlobal[datum][satHH] = (naplataStolaPoSatuGlobal[datum][satHH] || 0) + iznos;
        }
        if (vrstaNorm === "Na stol") {
            if (!naStolPoSatuGlobal[datum]) naStolPoSatuGlobal[datum] = {};
            naStolPoSatuGlobal[datum][satHH] = (naStolPoSatuGlobal[datum][satHH] || 0) + iznos;
        }
    }

      });
        // Jutro/Popodne ukupno (iz naplate_po_satu ako postoji; fallback na totalsByType)
        let jutroSuma = 0, popodneSuma = 0;
        const sati = pronadiPodatkeNaplate(datum);
        if (sati) {
            for (let h = 6; h <= 15; h++) jutroSuma += sati[h.toString().padStart(2, '0')] || 0;
            for (let h = 16; h <= 23; h++) popodneSuma += sati[h.toString().padStart(2, '0')] || 0;
            popodneSuma += sati["00"] || 0;
        } else {
            if (totalsByType["Jutro"]) jutroSuma = totalsByType["Jutro"];
            if (totalsByType["Popodne"]) popodneSuma = totalsByType["Popodne"];
        }

        const razlikaJutro = naStolJutro - naplataStolaJutro;
        const razlikaPopodne = naStolPopodne - naplataStolaPopodne;
        // ‚ñ∂ zbroj gornjih (naplate) i donjih (razlike)
        const gornjiZbroj = jutroSuma + popodneSuma;
        const donjiZbroj  = razlikaJutro + razlikaPopodne;
        const ukupnoVrijednost = gornjiZbroj + donjiZbroj;
        const jutroBottom    = jutroSuma + razlikaJutro;       // = "ukupno-bottom" za Jutro
        const popodneBottom  = popodneSuma + razlikaPopodne;   // = "ukupno-bottom" za Popodne

        // Kuƒáice Jutro/Popodne (ostaju kao do sada, ali J/P imaju razliku i combined)
        dateList.appendChild(
          kreirajWidgetVrste("Jutro", jutroSuma, datum, {
            diff: { naStol: naStolJutro, naplataStola: naplataStolaJutro },
            period: "Jutro"
          })
        );
        dateList.appendChild(
          kreirajWidgetVrste("Popodne", popodneSuma, datum, {
            diff: { naStol: naStolPopodne, naplataStola: naplataStolaPopodne },
            period: "Popodne"
          })
        );

        // ‚ñ∂ Ukupno sa komponentama (gornji, donji)
        dateList.appendChild(
          kreirajWidgetVrste("Ukupno", ukupnoVrijednost, datum, {
            components: { upper: gornjiZbroj, lower: donjiZbroj }
          })
        );

        tjedniZbroj += ukupnoVrijednost;
        daniPodaci.push({
          datum,
          jutro: jutroBottom,
          popodne: popodneBottom,
          ukupno: ukupnoVrijednost
        });

        // Ostali widgeti (osim Jutro/Popodne i ignorisanih)
        Object.entries(totalsByType)
            .filter(([vrsta]) => vrsta !== "Jutro" && vrsta !== "Popodne" && !ignoriraneVrste.includes(vrsta))
            .sort((a, b) => b[1] - a[1])
            .forEach(([vrsta, suma]) => {
                ostaliWrapper.appendChild(kreirajWidgetVrste(vrsta, suma, datum));
            });

        dateWidget.addEventListener("click", () => {
            ostaliWrapper.style.display = (ostaliWrapper.style.display === "none") ? "flex" : "none";
        });

        dateSection.appendChild(dateList);
        dateSection.appendChild(ostaliWrapper);
        summaryList.appendChild(dateSection);
    });

    // Prosjek (bez prvog dana)
    if (daniPodaci.length > 1) {
        const ostatakDana = [...daniPodaci].slice(1);
        const brojDana = ostatakDana.length;

        const prosjekJutro = brojDana > 0 ? ostatakDana.reduce((sum, d) => sum + d.jutro, 0) / brojDana : 0;
        const prosjekPopodne = brojDana > 0 ? ostatakDana.reduce((sum, d) => sum + d.popodne, 0) / brojDana : 0;
        const prosjekUkupno = brojDana > 0 ? ostatakDana.reduce((sum, d) => sum + d.ukupno, 0) / brojDana : 0;

        const prosjekList = document.createElement("ul");
        prosjekList.classList.add("summary-date", "prosjek-red");
        prosjekList.innerHTML = `
            <li><div class="naziv">Prosjek</div></li>
            <li><div class="iznos">${prosjekJutro.toFixed(2)} ‚Ç¨</div></li>
            <li><div class="iznos">${prosjekPopodne.toFixed(2)} ‚Ç¨</div></li>
            <li><div class="iznos">${prosjekUkupno.toFixed(2)} ‚Ç¨</div></li>
        `;

        const prviElement = summaryList.querySelector(".date-section");
        if (prviElement && prviElement.nextSibling) {
            summaryList.insertBefore(prosjekList, prviElement.nextSibling);
        }
    }

    // Tjedni ukupno
    const tjedniWidget = document.createElement("div");
    tjedniWidget.classList.add("tjedni-ukupno");
    tjedniWidget.innerHTML = `<strong>üìÖ Tjedan ukupno: ${tjedniZbroj.toFixed(2)} ‚Ç¨</strong>`;
    summaryList.appendChild(tjedniWidget);
}











function dodajKarticu(resultsContainer, item, totalsByType, datum) {
    const iznos = parseFloat(item.iznos.replace(" ‚Ç¨", "").replace(",", ".")) || 0;
    let vrsta = nazivMap[item.vrsta_akcije] || item.vrsta_akcije;

    // poku≈°aj izvuƒái sat (za period Jutro/Popodne)
    const sat = item.vrijeme ? parseInt(item.vrijeme.split(":")[0], 10) : NaN;
    const jeJutro = !isNaN(sat) && sat >= 6 && sat <= 14;

    let dataVrsta = vrsta;
    let dataDnevno = vrsta; // default (za veƒáinu akcija ostaje naziv vrste)

    if (vrsta === "Naplata" || vrsta === "Naplata stola") {
        // OVO ostaje kao do sada: ove vrste pune Jutro/Popodne total
        const vrstaDnevno = jeJutro ? "Jutro" : "Popodne";
        if (!totalsByType[vrstaDnevno]) totalsByType[vrstaDnevno] = 0;
        totalsByType[vrstaDnevno] += iznos;

        // "Naplata" se ne zbraja pod svojom vrstom, "Naplata stola" se zbraja
        if (vrsta !== "Naplata") {
            if (!totalsByType[vrsta]) totalsByType[vrsta] = 0;
            totalsByType[vrsta] += iznos;
        }

        dataDnevno = vrstaDnevno; // bitno za filtriranje po periodu
    } else {
        // Sve ostale vrste pune svoj vlastiti total
        if (!totalsByType[vrsta]) totalsByType[vrsta] = 0;
        totalsByType[vrsta] += iznos;

        // KLJUƒåNA IZMJENA: za "Na stol" obavezno tagujemo period za filtriranje
        if (vrsta === "Na stol" && !isNaN(sat)) {
            dataDnevno = jeJutro ? "Jutro" : "Popodne";
        } else {
            dataDnevno = vrsta; // ostale ostaju kao ≈°to jesu
        }
    }

    const cardHTML = document.createElement("div");
    cardHTML.classList.add("card");

    cardHTML.setAttribute("data-vrsta", dataVrsta);
    cardHTML.setAttribute("data-dnevno", dataDnevno);
    cardHTML.setAttribute("data-datum", datum);

    cardHTML.innerHTML = `
        <div class="card-header">
            <span class="vrijeme">${item.vrijeme || ""}</span>
            <span class="vrsta">${vrsta}</span>
            <span class="iznos">${item.iznos}</span>
        </div>
        <div class="card-opis">${item.opis || "-"}</div>
    `;
    resultsContainer.appendChild(cardHTML);
}







function kreirajWidgetVrste(vrsta, suma, datum, options = {}) {
  const { diff = null, components = null } = options;

  const item = document.createElement("li");
  item.setAttribute("data-vrsta", vrsta);
  item.setAttribute("data-datum", datum);

  item.addEventListener("click", () => {
    toggleFiltriranje(vrsta, datum, item);
  });

  // glavni ukupni iznos (koristi se i za dno Ukupno widgeta)
  const mainTotalHTML = `<div class="iznos ukupno-bottom">${Number(suma).toFixed(2)} ‚Ç¨</div>`;

  let bodyHTML = "";

  // Jutro/Popodne: razlika i combined (suma + razlika) ostaju kako jesu
  if ((vrsta === "Jutro" || vrsta === "Popodne") && diff) {
    const naStol   = Number(diff.naStol) || 0;
    const napStola = Number(diff.naplataStola) || 0;
    const razlika  = naStol - napStola;
    const combined = Number(suma) + razlika;

    bodyHTML += `
      <div class="iznos">${Number(suma).toFixed(2)} ‚Ç¨</div>
      <div class="podiznos">${razlika.toFixed(2)} ‚Ç¨</div>
      <div class="podiznos ukupno-red">${combined.toFixed(2)} ‚Ç¨</div>
    `;
  }

  // UKUPNO: prvo prika≈æi dva sub reda, pa NA DNU glavni ukupni iznos
  else if (vrsta === "Ukupno" && components && typeof components.upper === "number" && typeof components.lower === "number") {
    const upper = Number(components.upper) || 0;
    const lower = Number(components.lower) || 0;

    bodyHTML += `
      <div class="ukupno-sub">${upper.toFixed(2)} ‚Ç¨</div>
      <div class="ukupno-sub">${lower.toFixed(2)} ‚Ç¨</div>
      ${mainTotalHTML}
    `;
  }

  // Svi ostali widgeti (default)
  else {
    bodyHTML += `<div class="iznos">${Number(suma).toFixed(2)} ‚Ç¨</div>`;
  }

  item.innerHTML = `
    <div class="naziv">${nazivMap[vrsta] || vrsta}</div>
    ${bodyHTML}
  `;

  if (vrsta === "Ukupno") {
    item.classList.add("ukupno-bold");
  }

  return item;
}


















// GLOBAL: specijalni filter za pod-iznos (null ili {period, datum, vrste: [...]})
let customFilter = null;

// Primijeni trenutne filtere na kartice
function applyFilters(beforeApplyHook) {
    const cards = document.querySelectorAll("#results-container .card");

    if (typeof beforeApplyHook === "function") {
        beforeApplyHook();
    }

    // Ako je aktivan specijalni (pod-iznos) filter ‚Äì on ima prednost i ignori≈°e aktivniFilteri
    if (customFilter) {
        const { period, datum, vrste } = customFilter;
        cards.forEach(card => {
            const cardDatum = card.getAttribute("data-datum");
            const cardDnevno = card.getAttribute("data-dnevno");
            const cardVrsta = card.getAttribute("data-vrsta");
            const match = (cardDatum === datum) &&
                          (cardDnevno === period) &&
                          (vrste.includes(cardVrsta));
            card.style.display = match ? "block" : "none";
        });
        return;
    }

    // Inaƒçe ‚Äì stari re≈æim (OR logika)
    if (aktivniFilteri.size === 0) {
        cards.forEach(card => card.style.display = "none");
    } else {
        cards.forEach(card => {
            const cardVrsta = card.getAttribute("data-vrsta");
            const cardDnevno = card.getAttribute("data-dnevno");
            const cardDatum = card.getAttribute("data-datum");

            const cardKeyVrsta = `${cardVrsta}_${cardDatum}`;
            const cardKeyDnevno = `${cardDnevno}_${cardDatum}`;

            card.style.display = (aktivniFilteri.has(cardKeyVrsta) || aktivniFilteri.has(cardKeyDnevno))
                ? "block"
                : "none";
        });
    }
}

// Klik na pod-iznos (Na stol ‚àí Naplata stola)
function toggleSubLineFilter(period, datum, liElement, buttonEl) {
    // ako je veƒá aktivan isti specijalni filter ‚Äì ugasi
    const isSame =
        customFilter &&
        customFilter.period === period &&
        customFilter.datum === datum;

    if (isSame) {
        customFilter = null;
        liElement.classList.remove("active-sub");
    } else {
        customFilter = {
            period,
            datum,
            vrste: ["Naplata", "Naplata stola", "Na stol"]
        };
        // Po ≈æelji mo≈æe≈° oƒçistiti postojeƒáe standard filtere
        aktivniFilteri.clear();
        // UI naglasak
        liElement.classList.add("active-sub");
    }

    applyFilters();
}

// (ZAMJENA) ‚Äì malo prepakujemo postojeƒái toggle da koristi applyFilters()
function toggleFiltriranje(vrsta, datum, element) {
    const isPeriod = (vrsta === "Jutro" || vrsta === "Popodne");

    if (isPeriod) {
        // Klik na Jutro/Popodne ‚Äì prika≈æi samo Naplata, Naplata stola i Na stol u tom periodu
        const isSame = customFilter && customFilter.period === vrsta && customFilter.datum === datum;

        if (isSame) {
            customFilter = null;
            element.classList.remove("active", "active-sub");
        } else {
            customFilter = {
                period: vrsta,
                datum,
                vrste: ["Naplata", "Naplata stola", "Na stol"]
            };
            aktivniFilteri.clear(); // da ne smeta staro stanje
            element.classList.add("active", "active-sub");
        }
        applyFilters();
        return;
    }

    // Ostali widgeti ‚Äì standardno pona≈°anje
    customFilter = null;
    element.classList.remove("active-sub");

    const key = `${vrsta}_${datum}`;
    if (aktivniFilteri.has(key)) {
        aktivniFilteri.delete(key);
        element.classList.remove("active");
    } else {
        aktivniFilteri.add(key);
        element.classList.add("active");
    }
    applyFilters();
}





function prikaziPorukuBezPodataka() {
    document.getElementById("results-container").innerHTML = `<p>Nema podataka za odabrani raspon.</p>`;
    document.getElementById("artikli-summary-list").innerHTML = `<li><i>Nema potro≈°nje artikala za odabrani period.</i></li>`;
}

function prikaziPorukuOGresci() {
    document.getElementById("results-container").innerHTML = `<p style="color:red">Gre≈°ka pri dohvatu podataka.</p>`;
}

function prikaziPotrosnjuArtikala(potrosnja_artikala) {
    const artikliSummaryList = document.getElementById("artikli-summary-list");
    artikliSummaryList.innerHTML = "";

    if (!potrosnja_artikala) {
        artikliSummaryList.innerHTML = `<li><i>Nema potro≈°nje artikala za odabrani period.</i></li>`;
        return;
    }

    Object.entries(potrosnja_artikala)
        .sort((a, b) => b[1].kolicina - a[1].kolicina)
        .forEach(([naziv, statistika]) => {
            artikliSummaryList.innerHTML += `<li>${naziv} ‚Äî ${statistika.kolicina.toFixed(2)} kom (${statistika.broj} puta)</li>`;
        });
}



function prikaziGrafikone(naplate_po_satu) {
    if (!naplate_po_satu) return;
    prikaziGrafikon("modal-chart06_15", naplate_po_satu, 6, 15, naStolPoSatuGlobal, naplataStolaPoSatuGlobal);
    prikaziGrafikon("modal-chart15_01_b", naplate_po_satu, 16, 23, naStolPoSatuGlobal, naplataStolaPoSatuGlobal);
}






















  function zatvoriModal() {
    document.getElementById("artikli-modal").style.display = "none";
  }







  document.getElementById("drugired-form").addEventListener("submit", function(e) {
    e.preventDefault();
    fetchData();
  });

  document.getElementById("prev-day").addEventListener("click", function() {
      const dateFrom = parseDateInput("from_date");
      const dateTo = parseDateInput("to_date");

      // Pomakni oba datuma za -7 dana
      dateFrom.setDate(dateFrom.getDate() - 7);
      dateTo.setDate(dateTo.getDate() - 7);

      document.getElementById("from_date").value = formatDateToInput(dateFrom);
      document.getElementById("to_date").value = formatDateToInput(dateTo);

      fetchData();
  });

  document.getElementById("next-day").addEventListener("click", function() {
      const dateFrom = parseDateInput("from_date");
      const dateTo = parseDateInput("to_date");

      // Pomakni oba datuma za +7 dana
      dateFrom.setDate(dateFrom.getDate() + 7);
      dateTo.setDate(dateTo.getDate() + 7);

      document.getElementById("from_date").value = formatDateToInput(dateFrom);
      document.getElementById("to_date").value = formatDateToInput(dateTo);

      fetchData();
  });

  window.addEventListener("DOMContentLoaded", () => {
      const today = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(today.getDate() - 7);

      document.getElementById("from_date").value = formatDateToInput(weekAgo);
      document.getElementById("to_date").value = formatDateToInput(today);

      fetchData();
  });


document.getElementById("artikli-button").addEventListener("click", () => {
  otvoriArtikliModal();
});

function pronadiPotrosnjuZaDatum(datum) {
  if (!potrosnjaArtikalaPoDanuGlobal) return null;

  // 1) direktno
  if (potrosnjaArtikalaPoDanuGlobal[datum]) return potrosnjaArtikalaPoDanuGlobal[datum];

  // 2) bez vodeƒáih nula -> "1.8.2025"
  const parts = datum.split(".");
  if (parts.length >= 3) {
    const d = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    const y = parts[2];
    const bezNula = `${d}.${m}.${y}`;
    if (potrosnjaArtikalaPoDanuGlobal[bezNula]) return potrosnjaArtikalaPoDanuGlobal[bezNula];

    // 3) ISO -> "2025-08-01"
    const iso = `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    if (potrosnjaArtikalaPoDanuGlobal[iso]) return potrosnjaArtikalaPoDanuGlobal[iso];
  }

  return null;
}


function otvoriArtikliModal() {
  const modal = document.getElementById("artikli-modal");
  const listRoot = document.getElementById("artikli-summary-list");
  listRoot.innerHTML = "";

  // Ako NEMAMO per-dan strukturu -> fallback na staru ukupnu listu
  if (!potrosnjaArtikalaPoDanuGlobal || Object.keys(potrosnjaArtikalaPoDanuGlobal).length === 0) {
    if (!potrosnjaArtikalaGlobal || Object.keys(potrosnjaArtikalaGlobal).length === 0) {
      listRoot.innerHTML = `<li><i>Nema potro≈°nje artikala za odabrani period.</i></li>`;
    } else {
      Object.entries(potrosnjaArtikalaGlobal)
        .sort((a,b) => (b[1]?.kolicina || 0) - (a[1]?.kolicina || 0))
        .forEach(([naziv, s]) => {
          const li = document.createElement("li");
          li.className = "card";
          li.style.display = "block";
          li.style.marginBottom = "6px";
          li.innerHTML = `
            <div class="card-header">
              <span class="vrsta">${naziv}</span>
              <span class="iznos">${(s?.kolicina ?? 0).toFixed(2)} kom</span>
            </div>
            <div class="card-opis">Puta: ${s?.broj ?? 0}</div>
          `;
          listRoot.appendChild(li);
        });
    }
    modal.style.display = "block";
    return; // <- bitno!
  }

  // U suprotnom: imamo per-dan podatke -> prika≈æi widgete dana
  const daniWrap = document.createElement("ul");
  daniWrap.className = "summary-date";
  daniWrap.style.marginBottom = "10px";

  const dani = Object.keys(potrosnjaArtikalaPoDanuGlobal).sort(sortirajDatume);

  if (!dani || dani.length === 0) {
    listRoot.innerHTML = `<li><i>Nema potro≈°nje artikala za odabrani period.</i></li>`;
    modal.style.display = "block";
    return;
  }

  const karticeWrap = document.createElement("ul");
  karticeWrap.id = "artikli-kartice";
  karticeWrap.style.listStyle = "none";
  karticeWrap.style.padding = "0";
  karticeWrap.style.margin = "8px 0 0 0";

  let aktivniLi = null;

  const renderDan = (datum) => {
    if (aktivniLi) aktivniLi.classList.remove("active");
    const found = Array.from(daniWrap.children).find(li => li.getAttribute("data-datum") === datum);
    if (found) { aktivniLi = found; aktivniLi.classList.add("active"); }

    karticeWrap.innerHTML = "";
    const dataZaDan = pronadiPotrosnjuZaDatum(datum);

    if (!dataZaDan || Object.keys(dataZaDan).length === 0) {
      karticeWrap.innerHTML = `<li><i>Nema artikala za ${datum}.</i></li>`;
      return;
    }

    Object.entries(dataZaDan)
      .sort((a,b) => (b[1]?.kolicina || 0) - (a[1]?.kolicina || 0))
      .forEach(([naziv, s]) => {
        const li = document.createElement("li");
        li.className = "card";
        li.style.display = "block";
        li.style.marginBottom = "6px";
        li.innerHTML = `
          <div class="card-header">
            <span class="vrsta">${naziv}</span>
            <span class="iznos">${(s?.kolicina ?? 0).toFixed(2)} kom</span>
          </div>
          <div class="card-opis">Puta: ${s?.broj ?? 0}</div>
        `;
        karticeWrap.appendChild(li);
      });
  };

  dani.forEach(datum => {
    const li = document.createElement("li");
    li.setAttribute("data-datum", datum);
    li.innerHTML = `
      <div class="naziv">Dan</div>
      <div class="iznos">${datum}</div>
    `;
    li.addEventListener("click", () => renderDan(datum));
    daniWrap.appendChild(li);
  });

  listRoot.appendChild(daniWrap);
  listRoot.appendChild(karticeWrap);

  renderDan(dani[0]); // auto-prvi
  modal.style.display = "block";
}



</script>






<script src="{{ url_for('static', filename='js/kreiranje_grafikona.js') }}"></script>

</body>
</html>
