<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radnje korisnika</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f4f6f8;
      color: #333;
      padding-bottom: 80px; /* dovoljno za footer da ne preklopi sadr≈æaj */

    }


        .buttonstwo {
      display: flex;
      gap: 10px;
      margin-top: 5px;
      margin-right: 10px;
      margin-left: 10px;
      }






    .summary {
      display: block;       /* umjesto contents */
      width: 100%;
      margin: 0;
      padding: 0;
    }

    .summary ul,
.summary-date {
  list-style: none;
  margin: 0;
  padding: 0; /* üîπ ovo uklanja tu uvlaku od ~50px */
}

.date-section h3 {
  text-align: center;    /* centriraj tekst */
  margin: 0 0 10px 0;    /* makni default margine, ostavi malo ispod */
  padding: 0;
  font-size: 18px;       /* mo≈æe≈° prilagoditi */
  color: #2e3d49;        /* boja kao ≈°to veƒá ima≈° */
  font-weight: bold;
}


.summary-date {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  list-style: none;
  padding: 0;
  margin: 0;
  justify-content: flex-start; /* üîπ sla≈æe od lijeva bez centriranja */
}

.summary-date li {
  flex: 1 1 120px; /* minimalna ≈°irina 120px, raste≈æe se do raspolo≈æivog prostora */
  max-width: calc(25% - 8px); /* 4 po redu na veƒáim ekranima */
  box-sizing: border-box;
  padding: 12px;
  background-color: #dce6f1;
  border-radius: 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* Tableti - max 2 po redu */
@media (max-width: 768px) {
  .summary-date li {
    max-width: calc(50% - 8px);
  }
}

/* Mobiteli - 1 po redu */
@media (max-width: 480px) {
  .summary-date li {
    max-width: 100%;
  }
}

    .summary-date li.active {
      background-color: #93c5fd;
      transform: scale(1.03);
    }


















    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      align-items: center;
      justify-content: center;
    }

    input[type="date"], button {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #2e3d49;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover { background-color: #1b262f; }

    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 5px;
      display: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .card-header .vrijeme { font-weight: bold; color: #2e3d49; flex: 1; }
    .card-header .vrsta { text-align: center; flex: 1; font-weight: bold; color: #444; }
    .card-header .iznos { text-align: right; flex: 1; color: #006600; font-weight: bold; }
    .card-opis { font-size: 14px; color: #666; }





    #loader {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
      display: none;
    }

    @media (max-width: 768px) {
      input[type="date"], button { width: 100%; font-size: 18px; }
      form { flex-direction: column; }
    }


    .footer-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #2e3d49;
  display: flex;
  justify-content: space-around;
  z-index: 100;
}

.footer-bar button {
  background: #ffffff;
  color: #2e3d49;
  border: none;
  font-size: 16px;
  font-weight: bold;
}

.modal {
  display: none;
  position: fixed;
  z-index: 101;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fff;
  padding: 20px;
  border-radius: 5px;
  width: 100%;
  max-width: 500px;
  position: relative;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.modal-content h3 {
  margin-top: 0;
  color: #2e3d49;
  text-align: center;
}

.modal-content ul {
  list-style: none;
  padding-left: 0;
}

.modal-content li {
  padding: 8px 12px;
  background-color: #e0f7f1;
  border-radius: 8px;
  margin-bottom: 6px;
}
:fullscreen .modal-content {
  width: 100%;
  height: 100%;
  max-width: none;
  border-radius: 0;
  padding: 10px;
  box-sizing: border-box;
  overflow-y: auto;
}

.close {
  position: absolute;
  top: 10px;
  right: 16px;
  font-size: 24px;
  color: #666;
  cursor: pointer;
}

.date-range {
  display: flex;
  justify-content: space-between;
  width: 100%;
  gap: 10px;
  max-width: 400px;
  margin: 0 auto;
}


.modal-content canvas {
  width: 100% !important;
  height: 96vh !important; /* cijela visina ekrana */
  max-height: 100vh;
}



  </style>
</head>
<body>

  <div class="buttonstwo">
    <button id="prev-day">‚Üê Dan prije</button>
    <button id="next-day">Dan poslije ‚Üí</button>
  </div>

  <form id="filter-form">
  <div class="date-range">
    <input type="date" id="from_date" name="from_date" required>
    <input type="date" id="to_date" name="to_date" required>
  </div>
  <button type="submit">Prika≈æi</button>
</form>



  <div class="summary">
    <ul id="summary-list"></ul>
  </div>







  <p id="loader">Uƒçitavanje podataka...</p>
  <div id="results-container"></div>




  <!-- Footer bar -->
<div class="footer-bar">
  <button id="artikli-button">üì¶ Artikli</button>
  <button id="grafikon-button">üìà Grafikon</button>
  <button id="grafikon2-button">üìä Grafikon 2</button>
  <button>Prazno 3</button>
</div>

<!-- Artikli modal -->
<div id="artikli-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="zatvoriModal()">&times;</span>
    <h3>üì¶ Potro≈°nja artikala</h3>
    <ul id="artikli-summary-list"></ul>
  </div>
</div>

<!-- Grafikon modal -->
<div id="grafikon-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="zatvoriGrafikonModal()">&times;</span>
    <canvas id="modal-chart06_15"></canvas>
  </div>
</div>

<!-- Grafikon 2 modal -->
<div id="grafikon2-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="zatvoriGrafikon2Modal()">&times;</span>
    <canvas id="modal-chart15_01_b"></canvas>
  </div>
</div>









 <script>
  let aktivniFilteri = new Set();

  function formatDateToInput(date) {
    return date.toISOString().split("T")[0];
  }

  function formatDateForBackend(date) {
    return date.split("-").reverse().join(".");
  }

  function parseDateInput(inputId) {
    return new Date(document.getElementById(inputId).value);
  }

  function updateDateInputs(date) {
    const inputDate = formatDateToInput(date);
    document.getElementById("from_date").value = inputDate;
    document.getElementById("to_date").value = inputDate;
  }

async function fetchData() {
    const fromDate = formatDateForBackend(document.getElementById("from_date").value);
    const toDate = formatDateForBackend(document.getElementById("to_date").value);
    const loader = document.getElementById("loader");
    const resultsContainer = document.getElementById("results-container");
    const summaryList = document.getElementById("summary-list");
    const artikliSummaryList = document.getElementById("artikli-summary-list");

    // Reset prikaza
    artikliSummaryList.innerHTML = "";
    loader.style.display = "block";
    resultsContainer.innerHTML = "";
    summaryList.innerHTML = "";
    aktivniFilteri.clear();

    let result;
    try {
        const response = await fetch("/api/radnje_korisnika", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ from_date: fromDate, to_date: toDate })
        });

        result = await response.json();
    } catch (err) {
        console.error("Gre≈°ka kod dohvata podataka:", err);
        loader.style.display = "none";
        resultsContainer.innerHTML = `<p style="color:red">Gre≈°ka pri dohvatu podataka.</p>`;
        return;
    }

    loader.style.display = "none";

    // Sigurnosna provjera
    if (!(result.success && result.data_po_datumima && Object.keys(result.data_po_datumima).length > 0)) {
        resultsContainer.innerHTML = `<p>Nema podataka za odabrani raspon.</p>`;
        artikliSummaryList.innerHTML = `<li><i>Nema potro≈°nje artikala za odabrani period.</i></li>`;
        return;
    }

    // Vrste koje ignoriramo
    const ignoriraneVrste = [
        "Prijava", "Odjava", "Izlaz iz aplikacije", "ƒåitanje liste totala", "ƒåitanje totala konobara",
        "Prijava, neuspje≈°na", "Ostalo", "Pokretanje aplikacije", "ƒåitanje totala", "Premje≈°tanje stola"
    ];

    // Prolazimo kroz svaki datum
    Object.keys(result.data_po_datumima)
        .sort((a, b) => {
            const [da, ma, ya] = a.split(".");
            const [db, mb, yb] = b.split(".");
            return new Date(yb, mb - 1, db) - new Date(ya, ma - 1, da);
        })
        .forEach(datum => {
            const items = result.data_po_datumima[datum];
            const totalsByType = {};

            // Dodavanje sekcije za datum
            const dateSection = document.createElement("div");
            dateSection.classList.add("date-section");

            const dateTitle = document.createElement("h3");
            dateTitle.textContent = datum;
            dateSection.appendChild(dateTitle);

            const dateList = document.createElement("ul");
            dateList.classList.add("summary-date");

            items.forEach(item => {
                const iznos = parseFloat(item.iznos.replace(" ‚Ç¨", "").replace(",", ".")) || 0;
                const vrsta = item.vrsta_akcije;

                if (!totalsByType[vrsta]) totalsByType[vrsta] = 0;
                totalsByType[vrsta] += iznos;

                // Dodaj karticu u rezultate
                const cardHTML = document.createElement("div");
                cardHTML.classList.add("card");
                cardHTML.setAttribute("data-vrsta", vrsta);
                cardHTML.innerHTML = `
                    <div class="card-header">
                        <span class="vrijeme">${item.vrijeme}</span>
                        <span class="vrsta">${vrsta}</span>
                        <span class="iznos">${item.iznos}</span>
                    </div>
                    <div class="card-opis">${item.opis || "-"}</div>
                `;
                resultsContainer.appendChild(cardHTML);
            });

            // Widgeti za vrste radnji tog dana
            Object.entries(totalsByType)
                .filter(([vrsta]) => !ignoriraneVrste.includes(vrsta))
                .sort((a, b) => b[1] - a[1])
                .forEach(([vrsta, suma]) => {
                    const item = document.createElement("li");
                    item.setAttribute("data-vrsta", vrsta);
                    item.addEventListener("click", () => toggleFiltriranje(vrsta, item));

                    const prikazIznosa =
                        vrsta === "ƒåitanje totala"
                            ? `${suma} ƒçitanja`
                            : `${suma.toFixed(2)} ‚Ç¨`;

                    item.innerHTML = `
                        <div class="naziv">${vrsta}</div>
                        <div class="iznos">${prikazIznosa}</div>
                    `;
                    dateList.appendChild(item);
                });

            dateSection.appendChild(dateList);
            summaryList.appendChild(dateSection);
        });

    // Potro≈°nja artikala
    if (result.potrosnja_artikala) {
        artikliSummaryList.innerHTML = "";
        Object.entries(result.potrosnja_artikala)
            .sort((a, b) => b[1].kolicina - a[1].kolicina)
            .forEach(([naziv, statistika]) => {
                artikliSummaryList.innerHTML += `<li>${naziv} ‚Äî ${statistika.kolicina.toFixed(2)} kom (${statistika.broj} puta)</li>`;
            });
    }

    // Grafikoni po satu
    if (result.naplate_po_satu) {
        prikaziGrafikon("modal-chart06_15", result.naplate_po_satu, 6, 15);
        prikaziGrafikon("modal-chart15_01_b", result.naplate_po_satu, 16, 24);
    }
}





  function zatvoriModal() {
    document.getElementById("artikli-modal").style.display = "none";
  }



  function toggleFiltriranje(vrsta, element) {
    const cards = document.querySelectorAll("#results-container .card");

    if (aktivniFilteri.has(vrsta)) {
      aktivniFilteri.delete(vrsta);
      element.classList.remove("active");
    } else {
      aktivniFilteri.add(vrsta);
      element.classList.add("active");
    }

    if (aktivniFilteri.size === 0) {
      cards.forEach(card => card.style.display = "none");
    } else {
      cards.forEach(card => {
        const cardVrsta = card.getAttribute("data-vrsta");
        card.style.display = aktivniFilteri.has(cardVrsta) ? "block" : "none";
      });
    }
  }



  document.getElementById("filter-form").addEventListener("submit", function(e) {
    e.preventDefault();
    fetchData();
  });

  document.getElementById("prev-day").addEventListener("click", function() {
    const date = parseDateInput("from_date");
    date.setDate(date.getDate() - 1);
    updateDateInputs(date);
    fetchData();
  });

  document.getElementById("next-day").addEventListener("click", function() {
    const date = parseDateInput("from_date");
    date.setDate(date.getDate() + 1);
    updateDateInputs(date);
    fetchData();
  });

  window.addEventListener("DOMContentLoaded", () => {
      const today = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(today.getDate() - 7);

      document.getElementById("from_date").value = formatDateToInput(weekAgo);
      document.getElementById("to_date").value = formatDateToInput(today);

      fetchData();
  });


  document.getElementById("artikli-button").addEventListener("click", () => {
  document.getElementById("artikli-modal").style.display = "block";
  });

</script>


















<script>
let grafikonCache = {};

function prikaziGrafikon(canvasId, naplate_po_satu, odSat, doSat) {
  const labels = [];
  for (let h = odSat; h <= doSat; h++) {
    labels.push(h.toString().padStart(2, '0'));
  }
  if (doSat === 23) {
    labels.push("00");
  }

  const datasets = [];
  const customLabels = [];

  Object.entries(naplate_po_satu).forEach(([datum, sati], index) => {
    const podaci = labels.map(sat => sati[sat] || 0);
    const zbroj = podaci.reduce((a, b) => a + b, 0);
    const datumParts = datum.split('.');
    const datumObj = new Date(`${datumParts[2]}-${datumParts[1]}-${datumParts[0]}`);
    const daniUTjednu = ['ned', 'pon', 'uto', 'sri', 'ƒçet', 'pet', 'sub'];
    const dan = daniUTjednu[datumObj.getDay()];
    const prikazDatuma = `${datumParts[0]}.${datumParts[1]}.\n${dan}\n(${zbroj.toFixed(2)} ‚Ç¨)`;

    customLabels.push(prikazDatuma);

    datasets.push({
      label: prikazDatuma,
      data: podaci,
      fill: false,
      borderColor: `hsl(${(index * 67) % 360}, 70%, 50%)`,
      tension: 0,
      pointRadius: 0,
      pointHoverRadius: 6
    });
  });

  // ‚úÖ Sada izraƒçunavamo maksimalnu vrijednost iz svih podataka
  let maxValue = 0;
  datasets.forEach(dataset => {
    const localMax = Math.max(...dataset.data);
    if (localMax > maxValue) maxValue = localMax;
  });
  const yMax = Math.ceil((maxValue + 10) / 10) * 10;

  if (grafikonCache[canvasId]) {
    grafikonCache[canvasId].destroy();
  }

  const ctx = document.getElementById(canvasId).getContext("2d");

  grafikonCache[canvasId] = new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false, // <-- dodaj ovo!
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: ctx => ctx.raw.toFixed(2) + ' ‚Ç¨'
          }
        },
        datalabels: {
          color: '#333',
          align: 'top',
          anchor: 'end',
          formatter: value => value > 0 ? value.toFixed(2) + ' ‚Ç¨' : ''
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: yMax,
          ticks: {
                display: false, // sakriva brojeve sa y-osi
            stepSize: 10,
            callback: value => value + " ‚Ç¨"
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function resizeChartToScreen(canvasId) {
  const canvas = document.getElementById(canvasId);
  if (canvas) {
    canvas.style.height = window.innerHeight + "px";
  }
}

function zatvoriGrafikonModal() {
  document.getElementById("grafikon-modal").style.display = "none";
}

function zatvoriGrafikon2Modal() {
  document.getElementById("grafikon2-modal").style.display = "none";
}


document.getElementById("grafikon-button").addEventListener("click", () => {
  const modal = document.getElementById("grafikon-modal");
  modal.style.display = "block";
  resizeChartToScreen("modal-chart06_15");
});

document.getElementById("grafikon2-button").addEventListener("click", () => {
  const modal = document.getElementById("grafikon2-modal");
  modal.style.display = "block";
  resizeChartToScreen("modal-chart15_01_b");
});

</script>

</body>
</html>
