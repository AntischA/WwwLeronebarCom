<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f6f8;
      color: #333;
    }

    .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .summary ul { display: contents; }

    .summary li {
      width: calc(50% - 10px);
      padding: 12px;
      background-color: #dce6f1;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .summary li.active {
      background-color: #93c5fd;
      transform: scale(1.03);
    }

    .summary li .naziv { font-weight: bold; color: #2e3d49; }
    .summary li .iznos { font-size: 15px; color: #006600; }

    .artikli-summary ul { list-style: none; padding-left: 0; }
    .artikli-summary li {
      padding: 8px 12px;
      background-color: #e0f7f1;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      align-items: center;
      justify-content: center;
    }

    input[type="date"], button {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #2e3d49;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover { background-color: #1b262f; }

    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
      margin-top: 15px;
      display: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .card-header .vrijeme { font-weight: bold; color: #2e3d49; flex: 1; }
    .card-header .vrsta { text-align: center; flex: 1; font-weight: bold; color: #444; }
    .card-header .iznos { text-align: right; flex: 1; color: #006600; font-weight: bold; }
    .card-opis { font-size: 14px; color: #666; }

    .buttons { margin-top: 15px; text-align: center; }
    .buttons button { margin: 0 10px; }

    #loader {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
      display: none;
    }

    @media (max-width: 768px) {
      input[type="date"], button { width: 100%; font-size: 18px; }
      form { flex-direction: column; }
    }
  </style>
</head>
<body>

  <form id="filter-form">
    <input type="date" id="from_date" name="from_date" required>
    <input type="date" id="to_date" name="to_date" required>
    <button type="submit">Prika≈æi</button>
  </form>

  <div class="buttons">
    <button id="prev-day">‚Üê Dan prije</button>
    <button id="next-day">Dan poslije ‚Üí</button>
  </div>

  <div class="summary">
    <ul id="summary-list"></ul>
  </div>

  <div style="text-align:center; margin-bottom: 10px;">
    <button onclick="prikaziSveKartice()">üîÅ Prika≈æi sve</button>
  </div>

  <hr>

  <div class="artikli-summary">
    <ul id="artikli-summary-list"></ul>
  </div>





  <p id="loader">Uƒçitavanje podataka...</p>
  <div id="results-container"></div>

 <script>
  let aktivniFilteri = new Set();

  function formatDateToInput(date) {
    return date.toISOString().split("T")[0];
  }

  function formatDateForBackend(date) {
    return date.split("-").reverse().join(".");
  }

  function parseDateInput(inputId) {
    return new Date(document.getElementById(inputId).value);
  }

  function updateDateInputs(date) {
    const inputDate = formatDateToInput(date);
    document.getElementById("from_date").value = inputDate;
    document.getElementById("to_date").value = inputDate;
  }

  async function fetchData() {
    const fromDate = formatDateForBackend(document.getElementById("from_date").value);
    const toDate = formatDateForBackend(document.getElementById("to_date").value);
    const loader = document.getElementById("loader");
    const resultsContainer = document.getElementById("results-container");
    const summaryList = document.getElementById("summary-list");
    const artikliSummaryList = document.getElementById("artikli-summary-list");

    artikliSummaryList.innerHTML = "";
    loader.style.display = "block";
    resultsContainer.innerHTML = "";
    summaryList.innerHTML = "";
    aktivniFilteri.clear();

    const response = await fetch("/api/radnje_korisnika", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from_date: fromDate, to_date: toDate })
    });

    const result = await response.json();
    loader.style.display = "none";

    if (result.success && result.data.length > 0) {
      const totals = {};

      result.data.forEach(item => {
        const iznos = parseFloat(item.iznos.replace(" ‚Ç¨", "").replace(",", ".")) || 0;
        const vrsta = item.vrsta_akcije;

        const cardHTML = document.createElement("div");
        cardHTML.classList.add("card");
        cardHTML.setAttribute("data-vrsta", vrsta);
        cardHTML.innerHTML = `
          <div class="card-header">
            <span class="vrijeme">${item.vrijeme}</span>
            <span class="vrsta">${vrsta}</span>
            <span class="iznos">${item.iznos}</span>
          </div>
          <div class="card-opis">${item.opis || "-"}</div>
        `;
        resultsContainer.appendChild(cardHTML);

        if (!totals[vrsta]) totals[vrsta] = 0;
        totals[vrsta] += iznos;
      });

      const ignoriraneVrste = [
        "Prijava", "Odjava", "Izlaz iz aplikacije",
        "Prijava, neuspje≈°na", "Ostalo", "Pokretanje aplikacije"
      ];

      const sortiraniTotali = Object.entries(totals)
        .filter(([vrsta]) => !ignoriraneVrste.includes(vrsta))
        .sort((a, b) => {
          if (a[0] === "ƒåitanje totala") return 1;
          if (b[0] === "ƒåitanje totala") return -1;
          return b[1] - a[1];
        });

      sortiraniTotali.forEach(([vrsta, suma]) => {
        const item = document.createElement("li");
        item.setAttribute("data-vrsta", vrsta);
        item.addEventListener("click", () => toggleFiltriranje(vrsta, item));

        const prikazIznosa =
          vrsta === "ƒåitanje totala"
            ? `${suma} ƒçitanja`
            : `${suma.toFixed(2)} ‚Ç¨`;

        item.innerHTML = `
          <div class="naziv">${vrsta}</div>
          <div class="iznos">${prikazIznosa}</div>
        `;
        summaryList.appendChild(item);
      });

      if (result.potrosnja_artikala) {
        artikliSummaryList.innerHTML = `<li><b>üì¶ Potro≈°nja artikala:</b></li>`;
        Object.entries(result.potrosnja_artikala)
          .sort((a, b) => b[1].kolicina - a[1].kolicina)
          .forEach(([naziv, statistika]) => {
            artikliSummaryList.innerHTML += `<li>${naziv} ‚Äî ${statistika.kolicina.toFixed(2)} kom (${statistika.broj} puta)</li>`;
          });
      }

    } else {
      resultsContainer.innerHTML = `<p>Nema podataka za odabrani raspon.</p>`;
      artikliSummaryList.innerHTML = `<li><i>Nema potro≈°nje artikala za odabrani dan.</i></li>`;
    }
  }

  function toggleFiltriranje(vrsta, element) {
    const cards = document.querySelectorAll("#results-container .card");

    if (aktivniFilteri.has(vrsta)) {
      aktivniFilteri.delete(vrsta);
      element.classList.remove("active");
    } else {
      aktivniFilteri.add(vrsta);
      element.classList.add("active");
    }

    if (aktivniFilteri.size === 0) {
      cards.forEach(card => card.style.display = "none");
    } else {
      cards.forEach(card => {
        const cardVrsta = card.getAttribute("data-vrsta");
        card.style.display = aktivniFilteri.has(cardVrsta) ? "block" : "none";
      });
    }
  }

  function prikaziSveKartice() {
    aktivniFilteri.clear();
    document.querySelectorAll(".summary li").forEach(li => li.classList.remove("active"));
    document.querySelectorAll("#results-container .card").forEach(card => {
      card.style.display = "block";
    });
  }

  document.getElementById("filter-form").addEventListener("submit", function(e) {
    e.preventDefault();
    fetchData();
  });

  document.getElementById("prev-day").addEventListener("click", function() {
    const date = parseDateInput("from_date");
    date.setDate(date.getDate() - 1);
    updateDateInputs(date);
    fetchData();
  });

  document.getElementById("next-day").addEventListener("click", function() {
    const date = parseDateInput("from_date");
    date.setDate(date.getDate() + 1);
    updateDateInputs(date);
    fetchData();
  });

  window.addEventListener("DOMContentLoaded", () => {
    const today = new Date();
    updateDateInputs(today);
    fetchData();
  });
</script>

</body>
</html>
