<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f4f6f8;
      color: #333;
      padding-bottom: 80px; /* dovoljno za footer da ne preklopi sadr≈æaj */

    }

    .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
      margin-top: 10px;
    }

    .summary ul { display: contents; }

    .summary li {
      width: calc(50% - 10px);
      padding: 12px;
      background-color: #dce6f1;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .summary li.active {
      background-color: #93c5fd;
      transform: scale(1.03);
    }

    .summary li .naziv { font-weight: bold; color: #2e3d49; }
    .summary li .iznos { font-size: 15px; color: #006600; }

    .artikli-summary ul { list-style: none; padding-left: 0; }
    .artikli-summary li {
      padding: 8px 12px;
      background-color: #e0f7f1;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      align-items: center;
      justify-content: center;
    }

    input[type="date"], button {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #2e3d49;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover { background-color: #1b262f; }

    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 5px;
      display: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .card-header .vrijeme { font-weight: bold; color: #2e3d49; flex: 1; }
    .card-header .vrsta { text-align: center; flex: 1; font-weight: bold; color: #444; }
    .card-header .iznos { text-align: right; flex: 1; color: #006600; font-weight: bold; }
    .card-opis { font-size: 14px; color: #666; }

    .buttons {
      margin-top: 15px;
      text-align: center;
      margin-bottom: 15px;
    }

    .buttons button {
      margin: 10px 20px;
    }

    .buttonstwo {
      display: flex;
      gap: 10px;
      margin-top: 5px;
      margin-right: 10px;
      margin-left: 10px;
      }


    #loader {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
      display: none;
    }

    @media (max-width: 768px) {
      input[type="date"], button { width: 100%; font-size: 18px; }
      form { flex-direction: column; }
    }


    .footer-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #2e3d49;
  display: flex;
  justify-content: space-around;
  z-index: 100;
}

.footer-bar button {
  background: #ffffff;
  color: #2e3d49;
  border: none;
  font-size: 16px;
  font-weight: bold;
}

.modal {
  display: none;
  position: fixed;
  z-index: 101;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fff;
  padding: 20px;
  border-radius: 5px;
  width: 100%;
  max-width: 500px;
  position: relative;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.modal-content h3 {
  margin-top: 0;
  color: #2e3d49;
  text-align: center;
}

.modal-content ul {
  list-style: none;
  padding-left: 0;
}

.modal-content li {
  padding: 8px 12px;
  background-color: #e0f7f1;
  border-radius: 8px;
  margin-bottom: 6px;
}

.close {
  position: absolute;
  top: 10px;
  right: 16px;
  font-size: 24px;
  color: #666;
  cursor: pointer;
}

.date-range {
  display: flex;
  justify-content: space-between;
  width: 100%;
  gap: 10px;
  max-width: 400px;
  margin: 0 auto;
}




  </style>
</head>
<body>

  <div class="buttonstwo">
    <button id="prev-day">‚Üê Dan prije</button>
    <button id="next-day">Dan poslije ‚Üí</button>
  </div>

  <form id="filter-form">
  <div class="date-range">
    <input type="date" id="from_date" name="from_date" required>
    <input type="date" id="to_date" name="to_date" required>
  </div>
  <button type="submit">Prika≈æi</button>
</form>



  <div class="summary">
    <ul id="summary-list"></ul>
  </div>







  <p id="loader">Uƒçitavanje podataka...</p>
  <div id="results-container"></div>




  <!-- Footer bar -->
<div class="footer-bar">
  <button id="artikli-button">üì¶ Artikli</button>
  <button id="grafikon-button">üìà Grafikon</button>
  <button>Prazno 2</button>
  <button>Prazno 3</button>
</div>

<!-- Artikli modal -->
<div id="artikli-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="zatvoriModal()">&times;</span>
    <h3>üì¶ Potro≈°nja artikala</h3>
    <ul id="artikli-summary-list"></ul>
  </div>
</div>

<!-- Grafikon modal -->
<div id="grafikon-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="zatvoriGrafikonModal()">&times;</span>
    <h3 style="text-align: center;">üìà Naplate po satu</h3>
    <canvas id="modal-chart06_15" style="height: 300px;"></canvas>
    <hr>
    <canvas id="modal-chart15_01" style="height: 300px;"></canvas>
  </div>
</div>



 <script>
  let aktivniFilteri = new Set();

  function formatDateToInput(date) {
    return date.toISOString().split("T")[0];
  }

  function formatDateForBackend(date) {
    return date.split("-").reverse().join(".");
  }

  function parseDateInput(inputId) {
    return new Date(document.getElementById(inputId).value);
  }

  function updateDateInputs(date) {
    const inputDate = formatDateToInput(date);
    document.getElementById("from_date").value = inputDate;
    document.getElementById("to_date").value = inputDate;
  }

  async function fetchData() {
    const fromDate = formatDateForBackend(document.getElementById("from_date").value);
    const toDate = formatDateForBackend(document.getElementById("to_date").value);
    const loader = document.getElementById("loader");
    const resultsContainer = document.getElementById("results-container");
    const summaryList = document.getElementById("summary-list");
    const artikliSummaryList = document.getElementById("artikli-summary-list");

    artikliSummaryList.innerHTML = "";
    loader.style.display = "block";
    resultsContainer.innerHTML = "";
    summaryList.innerHTML = "";
    aktivniFilteri.clear();

    const response = await fetch("/api/radnje_korisnika", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from_date: fromDate, to_date: toDate })
    });

    const result = await response.json();
    loader.style.display = "none";

    if (result.success && result.data.length > 0) {
      const totals = {};

      result.data.forEach(item => {
        const iznos = parseFloat(item.iznos.replace(" ‚Ç¨", "").replace(",", ".")) || 0;
        const vrsta = item.vrsta_akcije;

        const cardHTML = document.createElement("div");
        cardHTML.classList.add("card");
        cardHTML.setAttribute("data-vrsta", vrsta);
        cardHTML.innerHTML = `
          <div class="card-header">
            <span class="vrijeme">${item.vrijeme}</span>
            <span class="vrsta">${vrsta}</span>
            <span class="iznos">${item.iznos}</span>
          </div>
          <div class="card-opis">${item.opis || "-"}</div>
        `;
        resultsContainer.appendChild(cardHTML);

        if (!totals[vrsta]) totals[vrsta] = 0;
        totals[vrsta] += iznos;
      });

      const ignoriraneVrste = [
        "Prijava", "Odjava", "Izlaz iz aplikacije",
        "Prijava, neuspje≈°na", "Ostalo", "Pokretanje aplikacije"
      ];

      const sortiraniTotali = Object.entries(totals)
        .filter(([vrsta]) => !ignoriraneVrste.includes(vrsta))
        .sort((a, b) => {
          if (a[0] === "ƒåitanje totala") return 1;
          if (b[0] === "ƒåitanje totala") return -1;
          return b[1] - a[1];
        });

      sortiraniTotali.forEach(([vrsta, suma]) => {
        const item = document.createElement("li");
        item.setAttribute("data-vrsta", vrsta);
        item.addEventListener("click", () => toggleFiltriranje(vrsta, item));

        const prikazIznosa =
          vrsta === "ƒåitanje totala"
            ? `${suma} ƒçitanja`
            : `${suma.toFixed(2)} ‚Ç¨`;

        item.innerHTML = `
          <div class="naziv">${vrsta}</div>
          <div class="iznos">${prikazIznosa}</div>
        `;
        summaryList.appendChild(item);
      });

      if (result.potrosnja_artikala) {
        artikliSummaryList.innerHTML = "";
        Object.entries(result.potrosnja_artikala)
          .sort((a, b) => b[1].kolicina - a[1].kolicina)
          .forEach(([naziv, statistika]) => {
            artikliSummaryList.innerHTML += `<li>${naziv} ‚Äî ${statistika.kolicina.toFixed(2)} kom (${statistika.broj} puta)</li>`;
          });


    if (result.naplate_po_satu) {
  const dataPerHour = result.naplate_po_satu;
  const datum = Object.keys(dataPerHour)[0]; // Pretpostavljamo jedan dan
  const sati = dataPerHour[datum];

  const labels06_15 = [], values06_15 = [];
  const labels15_01 = [], values15_01 = [];

  for (let h = 6; h <= 15; h++) {
    const sat = h.toString().padStart(2, '0');
    labels06_15.push(sat);
    values06_15.push(sati[sat] || 0);
  }

  for (let h = 16; h <= 23; h++) {
    const sat = h.toString();
    labels15_01.push(sat.padStart(2, '0'));
    values15_01.push(sati[sat] || 0);
  }

  labels15_01.push("00");
  values15_01.push(sati["00"] || 0);

if (result.naplate_po_satu) {
prikaziGrafikon("modal-chart06_15", result.naplate_po_satu, 6, 15);
prikaziGrafikon("modal-chart15_01", result.naplate_po_satu, 16, 23);
}
    }

      } else {
      resultsContainer.innerHTML = `<p>Nema podataka za odabrani raspon.</p>`;
      artikliSummaryList.innerHTML = `<li><i>Nema potro≈°nje artikala za odabrani dan.</i></li>`;
    }
  }
 }



 let grafikonCache = {};

function prikaziGrafikon(canvasId, naplate_po_satu, odSat, doSat) {
  const labels = [];
  for (let h = odSat; h <= doSat; h++) {
    labels.push(h.toString().padStart(2, '0'));
  }
  if (doSat === 23) {
    labels.push("00");
  }

  const datasets = [];
  const customLabels = [];

  Object.entries(naplate_po_satu).forEach(([datum, sati], index) => {
    const podaci = labels.map(sat => sati[sat] || 0);
    const zbroj = podaci.reduce((a, b) => a + b, 0);
    const datumParts = datum.split('.');
    const datumObj = new Date(`${datumParts[2]}-${datumParts[1]}-${datumParts[0]}`);
    const daniUTjednu = ['ned', 'pon', 'uto', 'sri', 'ƒçet', 'pet', 'sub'];
    const dan = daniUTjednu[datumObj.getDay()];
    const prikazDatuma = `${datumParts[0]}.${datumParts[1]}.\n${dan}\n(${zbroj.toFixed(2)} ‚Ç¨)`;

    customLabels.push(prikazDatuma);

    datasets.push({
      label: prikazDatuma,
      data: podaci,
      fill: false,
      borderColor: `hsl(${(index * 67) % 360}, 70%, 50%)`,
      tension: 0,
      pointRadius: 0,
      pointHoverRadius: 6
    });
  });

  // ‚úÖ Sada izraƒçunavamo maksimalnu vrijednost iz svih podataka
  let maxValue = 0;
  datasets.forEach(dataset => {
    const localMax = Math.max(...dataset.data);
    if (localMax > maxValue) maxValue = localMax;
  });
  const yMax = Math.ceil((maxValue + 10) / 10) * 10;

  if (grafikonCache[canvasId]) {
    grafikonCache[canvasId].destroy();
  }

  const ctx = document.getElementById(canvasId).getContext("2d");

  grafikonCache[canvasId] = new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: ctx => ctx.raw.toFixed(2) + ' ‚Ç¨'
          }
        },
        datalabels: {
          color: '#333',
          align: 'top',
          anchor: 'end',
          formatter: value => value > 0 ? value.toFixed(2) + ' ‚Ç¨' : ''
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: yMax,
          ticks: {
                display: false, // sakriva brojeve sa y-osi
            stepSize: 10,
            callback: value => value + " ‚Ç¨"
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}



  function zatvoriModal() {
    document.getElementById("artikli-modal").style.display = "none";
  }

  function zatvoriGrafikonModal() {
    document.getElementById("grafikon-modal").style.display = "none";

    // Izaƒëi iz fullscreen i otkljuƒçaj orijentaciju
    if (document.fullscreenElement) {
      document.exitFullscreen();
    }

    if (screen.orientation && screen.orientation.unlock) {
      screen.orientation.unlock(); // Nije podr≈æano svuda
    }
  }


  function toggleFiltriranje(vrsta, element) {
    const cards = document.querySelectorAll("#results-container .card");

    if (aktivniFilteri.has(vrsta)) {
      aktivniFilteri.delete(vrsta);
      element.classList.remove("active");
    } else {
      aktivniFilteri.add(vrsta);
      element.classList.add("active");
    }

    if (aktivniFilteri.size === 0) {
      cards.forEach(card => card.style.display = "none");
    } else {
      cards.forEach(card => {
        const cardVrsta = card.getAttribute("data-vrsta");
        card.style.display = aktivniFilteri.has(cardVrsta) ? "block" : "none";
      });
    }
  }



  document.getElementById("filter-form").addEventListener("submit", function(e) {
    e.preventDefault();
    fetchData();
  });

  document.getElementById("prev-day").addEventListener("click", function() {
    const date = parseDateInput("from_date");
    date.setDate(date.getDate() - 1);
    updateDateInputs(date);
    fetchData();
  });

  document.getElementById("next-day").addEventListener("click", function() {
    const date = parseDateInput("from_date");
    date.setDate(date.getDate() + 1);
    updateDateInputs(date);
    fetchData();
  });

  window.addEventListener("DOMContentLoaded", () => {
    const today = new Date();
    updateDateInputs(today);
    fetchData();
  });


  document.getElementById("artikli-button").addEventListener("click", () => {
  document.getElementById("artikli-modal").style.display = "block";
  });

document.getElementById("grafikon-button").addEventListener("click", async () => {
  document.getElementById("grafikon-modal").style.display = "block";

  // Poku≈°aj uƒái u fullscreen i zakljuƒçati orijentaciju
  const modal = document.documentElement;

  try {
    if (modal.requestFullscreen) {
      await modal.requestFullscreen();
    } else if (modal.webkitRequestFullscreen) {
      await modal.webkitRequestFullscreen();
    }

    if (screen.orientation && screen.orientation.lock) {
      await screen.orientation.lock("landscape");
    }
  } catch (err) {
    console.warn("Zakljuƒçavanje orijentacije nije moguƒáe:", err);
  }
});


</script>

</body>
</html>
