<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>Lerone ‚Ä¢ Radio + Spotify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon (nema 404) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üéµ</text></svg>'>

  <style>
    :root{
      --bg:#0b1020; --card:#11182a; --soft:#0f1526;
      --text:#e8eef7; --muted:#a7b2c6; --line:#203055;
      --accent:#1db954; --accent2:#10b981;
      --radius:16px; --gap:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box }
    html, body { height:100% }
    body{
      margin:0; color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
      background: radial-gradient(1200px 600px at 30% -10%, #17213f 0%, #0b1020 55%, #0b1020 100%);
    }

    .app{
      width: clamp(320px, 80vw, 1280px);
      margin: 0 auto; padding: 22px var(--gap);
      display: grid; gap: var(--gap);
      grid-auto-rows: min-content;
      min-height: 100svh;
    }

    .h { margin:0; font-size:1.12rem; font-weight:800; letter-spacing:.2px; color:#e9f2ff }

    .grid{ display:grid; gap: var(--gap); grid-template-columns: 1fr 1fr }
    @media (max-width: 1100px){ .grid{ grid-template-columns: 1fr } }

    .card{
      background: linear-gradient(180deg, var(--card), var(--soft));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      display: flex; flex-direction: column; gap: 12px;
      min-height: 160px;
    }
    .panel{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      display:flex; flex-direction:column; gap:12px; min-height: 0;
    }
    .panel .h2{ margin:0; font-weight:700; letter-spacing:.2px; font-size:1rem }
    .row{ display:flex; align-items:center; gap:12px; min-width:0 }

    .btn{
      appearance:none; border:0; cursor:pointer;
      background: var(--accent);
      color:#062d16; font-weight:800;
      padding:12px 14px; border-radius:12px; min-width:110px;
      transition: transform .06s ease, filter .12s ease, opacity .12s ease;
    }
    .btn.alt{ background: var(--accent2); color:#04281f }
    .btn:active{ transform: translateY(1px) }
    .btn:disabled{ opacity:.55; cursor:not-allowed }

    .vol{ display:flex; align-items:center; gap:10px; color:var(--muted); flex:1 1 auto; min-width:0 }
    .vol span{ display:inline-block; width:4ch; text-align:right }
    .vol input[type="range"]{
      flex:1 1 auto; height:40px; background:transparent;
      appearance:none; -webkit-appearance:none;
    }
    .vol input[type="range"]::-webkit-slider-runnable-track{
      height:40px; border-radius:10px; background:var(--line);
    }
    .vol input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; width:26px; height:26px; margin-top:7px;
      border-radius:50%; background:#e8eef7; border:2px solid #0f1f39;
    }
    .vol input[type="range"]::-moz-range-track{ height:12px; border-radius:10px; background:var(--line) }
    .vol input[type="range"]::-moz-range-thumb{
      width:22px; height:22px; border-radius:50%; background:#e8eef7; border:2px solid #0f1f39
    }

    .ticker{ overflow:hidden; white-space:nowrap; font-size:.95rem; color:#dfe8f7;
      -webkit-mask-image:linear-gradient(90deg,transparent 0,#000 10%,#000 90%,transparent 100%);
              mask-image:linear-gradient(90deg,transparent 0,#000 10%,#000 90%,transparent 100%);
    }
    .ticker span{ display:inline-block; padding-left:100%; animation:ticker 12s linear infinite }
    @keyframes ticker{ from{ transform:translateX(0) } to{ transform:translateX(-100%) } }

    .list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; min-height:0; overflow:auto }
    .item{
      display:flex; align-items:center; gap:12px;
      background:#17213b; border-radius:12px; padding:10px 12px;
      cursor:pointer; transition: filter .12s ease, transform .06s ease;
    }
    .item:hover{ filter:brightness(1.07); transform: translateY(-1px) }
    .item.active{ outline:2px solid var(--accent2); background:#1a2747 }

    .thumb{ width:44px; height:44px; border-radius:10px; background:#24345e; object-fit:cover; flex:0 0 44px }
    .tcol{ min-width:0 }
    .t1{ font-weight:700; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .t2{ color:var(--muted); font-size:.82rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .playing{ outline:1px solid #3a7bd5; background:#15294f }

    .muted { color:var(--muted); font-size:.9rem }
    .sr-only{ position:absolute !important; left:-9999px !important }
  </style>
</head>
<body>
  <main class="app">
    <h1 class="h">Lerone ‚Ä¢ Radio + Spotify</h1>

    <!-- RADIO -->
    <section class="grid" aria-label="Radio blok">
      <article class="panel" aria-labelledby="radio-list-h">
        <h2 class="h2" id="radio-list-h">üìª Radio stanice</h2>
        <ul id="radioList" class="list" role="listbox" aria-label="Popis radio stanica"></ul>
      </article>

      <article class="card" aria-labelledby="radio-player-h">
        <h2 class="h2" id="radio-player-h">üîä <span id="ra-title">Odaberi stanicu lijevo</span></h2>
        <div class="row">
          <button id="ra-play" class="btn alt" aria-label="Reproduciraj radio">‚ñ∂ Play</button>
          <div class="vol">
            <span id="ra-vlbl">90%</span>
            <input id="ra-vol" type="range" min="0" max="1" step="0.01" value="0.9" aria-label="Glasnoƒáa radija">
          </div>
        </div>
        <div class="ticker" aria-live="polite"><span id="ra-now">Spreman za reprodukciju‚Ä¶</span></div>
        <!-- BEZ crossorigin zbog CORS na nekim streamovima -->
        <audio id="ra-audio" preload="none" playsinline></audio>
      </article>
    </section>

    <!-- SPOTIFY -->
    <section class="grid" aria-label="Spotify blok">
      <article class="card" aria-labelledby="spotify-player-h">
        <h2 class="h2" id="spotify-player-h">üéµ Spotify ‚Äî Player</h2>
        <div class="row">
          <button id="sp-play" class="btn" disabled aria-label="Reproduciraj Spotify">‚ñ∂ Play</button>
          <div class="vol">
            <span id="sp-vlbl">90%</span>
            <input id="sp-vol" type="range" min="0" max="1" step="0.01" value="0.9" aria-label="Glasnoƒáa Spotify">
          </div>
        </div>
        <div class="ticker" aria-live="polite"><span id="sp-now">Odaberi playlistu pa klikni Play.</span></div>
        <div class="sr-only" aria-hidden="true">
          <img id="sp-img" alt="">
          <div id="sp-track"></div>
          <div id="sp-artist"></div>
          <input id="sp-seek" type="range" min="0" max="100" step="1" value="0">
        </div>
        <div class="panel" style="background:transparent; box-shadow:none; padding:0">
          <h3 class="h2" style="margin-top:8px">üìö Moje playliste</h3>
          <ul id="pl-list" class="list" aria-label="Playliste"></ul>
        </div>
      </article>

      <article class="panel" aria-labelledby="tracks-h">
        <h2 class="h2" id="tracks-h">üéº Pjesme u playlisti</h2>
        <ul id="tracks" class="list"></ul>
        <div id="tracks-hint" class="muted">Odaberi playlistu iz ‚ÄúMoje playliste‚Äù.</div>
      </article>
    </section>
  </main>

  <!-- Spotify SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>
    /*************************************************
     * CONFIG
     *************************************************/
    // Ako koristi≈° HTTPS proxy (Cloudflare Worker, GCP), postavi bazu:
    // npr. const PROXY_BASE = 'https://radio-proxy.leronebar.com/?u=';
const PROXY_BASE = 'https://radio-proxy.maluma-d-o-o.workers.dev/?u=';

const STATIONS = [
  // postojeƒáe
  { id:'rd', name:'Radio Dalmacija ‚Äî Live', sources:['https://shoutcast.pondi.hr:9000/;'] },
  { id:'nx', name:'Naxi Radio ‚Äî Live',      sources:['https://naxi128ssl.streaming.rs:9152/;','https://naxi64ssl.streaming.rs:9162/;'] },
  { id:'ot', name:'Otvoreni Radio ‚Äî Live',  sources:['https://stream2.otvoreni.hr/otvoreni'] },

  // NOVO ‚Äî Naxi digital (HTTP ‚Üí idealno preko PROXY_BASE)
  { id:'nf', name:'Naxi Fresh ‚Äî Live', sources:[
    'http://naxidigital-fresh128.streaming.rs:8210/'
  ]},
  { id:'nm', name:'Naxi Mix ‚Äî Live', sources:[
    'http://naxidigital-mix128.streaming.rs:8220/'
  ]},

  // NOVO ‚Äî Bravo (zamijeni URL ako koristi≈° drugi Bravo stream)
  { id:'br', name:'Bravo Radio ‚Äî Live', sources:[
    // Ako ima≈° svoj toƒçan URL, stavi ga na 1. mjesto.
    // Primjer HTTP (ide preko PROXY_BASE):
    'http://streamer.radio-bravo.rs:8000/bravo',
    // Ako ima≈° HTTPS varijantu, dodaj je ispred HTTP-a:
    // 'https://streamer.radio-bravo.rs/bravo'
  ]},
];

    /*************************************************
     * UTILS
     *************************************************/
    const $ = s => document.querySelector(s);
    const el = (tag, cls) => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };
    const pct = v => Math.round((v||0) * 100) + '%';
    const setBtn = (btn, playing) => { btn.textContent = playing ? '‚è∏ Pause' : '‚ñ∂ Play'; };
    const resolveSrc = url => PROXY_BASE ? (PROXY_BASE + encodeURIComponent(url)) : url;
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    /*************************************************
     * RADIO MODULE
     *************************************************/
    const Radio = (() => {
      const listEl = $('#radioList');
      const titleEl = $('#ra-title');
      const nowEl = $('#ra-now');
      const audio = $('#ra-audio');
      const playBtn = $('#ra-play');
      const vol = $('#ra-vol'); const vlbl = $('#ra-vlbl');

      let currentId = null;
      let srcIndex = 0;
      let starting = false;

      const renderList = () => {
        listEl.innerHTML = '';
        STATIONS.forEach(s => {
          const li = el('li','item');
          li.textContent = s.name;
          li.dataset.id = s.id;
          li.onclick = () => select(s.id);
          if (s.id === currentId) li.classList.add('active');
          listEl.appendChild(li);
        });
      };

      const select = (id) => {
        const s = STATIONS.find(x => x.id === id);
        if (!s) return;
        try { audio.pause(); } catch(_) {}
        starting = false;
        currentId = id; srcIndex = 0;

        titleEl.textContent = s.name;
        nowEl.textContent = 'Spreman: ' + s.name;
        [...listEl.children].forEach(li => li.classList.toggle('active', li.dataset.id === id));

        playBtn.disabled = true;
        setTimeout(() => playBtn.disabled = false, 220);

        audio.removeAttribute('src');
        audio.src = resolveSrc(s.sources[0]);
        try { audio.load(); } catch(_) {}
        setBtn(playBtn, false);
      };

      const tryPlay = () => {
        if (starting) return;
        starting = true;

        Spotify.pauseQuiet(); // bez await da ne izgubimo ‚Äúuser gesture‚Äù

        const s = STATIONS.find(x => x.id === currentId);
        const success = () => {
          setBtn(playBtn, true);
          nowEl.textContent = 'Slu≈°ate: ' + (s?.name || 'Radio') + ' üé∂';
          starting = false;
        };
        const failover = async (err) => {
          if (s && srcIndex < s.sources.length - 1) {
            srcIndex++;
            audio.src = resolveSrc(s.sources[srcIndex]);
            try { audio.load(); } catch(_) {}
            attempt();
            return;
          }
          nowEl.textContent = (err && err.name === 'NotAllowedError')
            ? 'Preglednik blokira zvuk. Klikni jo≈° jednom.'
            : 'Ne mogu reproducirati stream. Poku≈°aj ponovno.';
          setBtn(playBtn, false);
          starting = false;
        };
        const attempt = () => {
          let p;
          try { p = audio.play(); } catch(e){ failover(e); return; }
          if (p?.then) p.then(success).catch(failover); else success();
        };
        attempt();
      };

      // UI hooks
      playBtn.addEventListener('click', () => {
        if (!currentId && STATIONS.length) select(STATIONS[0].id);
        if (audio.paused) tryPlay(); else audio.pause();
      });
      vol.addEventListener('input', () => {
        audio.volume = vol.valueAsNumber;
        vlbl.textContent = pct(vol.valueAsNumber);
      });

      // Audio lifecycle
      audio.addEventListener('playing', () => setBtn(playBtn, true));
      audio.addEventListener('pause', () => setBtn(playBtn, false));
      audio.addEventListener('stalled', () => {
        nowEl.textContent = 'Veza je zastala‚Ä¶ poku≈°avam ponovo.';
        try { audio.load(); audio.play().catch(()=>{}); } catch(_){}
      });
      audio.addEventListener('error', () => {
        const s = STATIONS.find(x => x.id === currentId); if (!s) return;
        if (srcIndex < s.sources.length - 1){
          srcIndex++;
          audio.src = resolveSrc(s.sources[srcIndex]);
          try { audio.load(); audio.play().catch(()=>{}); } catch(_){}
        } else {
          nowEl.textContent = 'Gre≈°ka na streamu. Poku≈°aj kasnije.';
          setBtn(playBtn, false);
        }
      });

      const init = () => {
        renderList();
        vlbl.textContent = pct(vol.valueAsNumber);
        if (STATIONS.length) select(STATIONS[0].id);
      };

      return {
        init,
        pause: () => { try { audio.pause(); } catch(_) {} },
      };
    })();

    /*************************************************
     * SPOTIFY MODULE
     *************************************************/
    const Spotify = (() => {
      // Elements
      const playBtn = $('#sp-play');
      const vol = $('#sp-vol'); const vlbl = $('#sp-vlbl');
      const nowEl = $('#sp-now');

      const plList = $('#pl-list');
      const trList = $('#tracks'); const trHint = $('#tracks-hint');

      // State
      let player = null, deviceId = null, ready = false, lock = false;
      let playlists = []; // [{uri,id,name,li}]
      let tracks = [];    // [{name,artists,uri,img}]
      let custom = null;  // current queue order (copy of tracks)
      let curIndex = -1;  // index in custom
      let curUri = null;
      const uriToLi = new Map();
      let lastPlayingEl = null;

      // Auth helpers (uses your backend)
      async function refreshAccessToken() {
        const rt = localStorage.getItem('refresh_token');
        if (!rt) { window.location.href = '/spotify_auth'; return null; }
        const res = await fetch('/refresh_token', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ refresh_token: rt })
        });
        const data = await res.json();
        if (res.ok && data.access_token) {
          localStorage.setItem('access_token', data.access_token);
          localStorage.setItem('token_timestamp', Date.now());
          return data.access_token;
        }
        console.error('Refresh failed', data);
        return null;
      }
      async function getToken() {
        const at = localStorage.getItem('access_token');
        const rt = localStorage.getItem('refresh_token');
        if (!rt) { window.location.href = '/spotify_auth'; return null; }
        const ts = parseInt(localStorage.getItem('token_timestamp') || '0', 10);
        if (!at || (Date.now()-ts) >= 55*60*1000) return await refreshAccessToken();
        return at;
      }

      async function ensureActiveDevice(){
        if (!deviceId) return;
        const token = await getToken(); if (!token) return;
        try{
          await fetch('https://api.spotify.com/v1/me/player', {
            method:'PUT',
            headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
            body: JSON.stringify({ device_ids:[deviceId], play:false })
          });
          await sleep(150);
        }catch(e){ console.warn('device transfer', e); }
      }

      function renderPlaylists(items){
        plList.innerHTML = '';
        playlists = [];
        items.forEach(p => {
          const li = el('li','item'); li.textContent = p.name; li.style.cursor='pointer';
          li.onclick = () => playPlaylist(p.uri);
          plList.appendChild(li);
          playlists.push({ uri:p.uri, id:p.id, name:p.name, li });
        });
      }
      function setActivePlaylist(uri){
        playlists.forEach(p => p.li.classList.toggle('active', p.uri === uri));
      }

      function renderTracks(arr){
        trList.innerHTML = ''; uriToLi.clear(); lastPlayingEl = null;
        arr.forEach((t, i) => {
          const li = el('li','item');
          const img = el('img','thumb'); img.src = t.img || ''; img.alt = 'Cover';
          const col = el('div','tcol');
          const t1 = el('div','t1'); t1.textContent = t.name;
          const t2 = el('div','t2'); t2.textContent = t.artists;
          col.append(t1, t2); li.append(img, col);
          li.onclick = () => { custom = arr.slice(); playByIndex(i); };
          if (t.uri === curUri) { li.classList.add('playing'); lastPlayingEl = li; }
          trList.appendChild(li); uriToLi.set(t.uri, li);
        });
        trHint.style.display = arr.length ? 'none' : 'block';
      }
      function highlight(uri){
        if (!uriToLi.has(uri)) return;
        if (lastPlayingEl) lastPlayingEl.classList.remove('playing');
        const li = uriToLi.get(uri);
        li.classList.add('playing');
        lastPlayingEl = li;
        li.scrollIntoView({ block:'center', behavior:'smooth' });
      }

      async function fetchTracks(playlistId){
        const token = await getToken(); if (!token) return [];
        let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;
        const items = [];
        while(url){
          const res = await fetch(url, { headers:{ Authorization:`Bearer ${token}` }});
          const data = await res.json();
          if (!data || !data.items) break;
          items.push(...data.items);
          url = data.next;
        }
        return items.map(it => {
          const t = it.track; if (!t) return null;
          return {
            name: t.name,
            artists: (t.artists||[]).map(a=>a.name).join(', '),
            uri: t.uri,
            img: (t.album?.images?.[t.album.images.length-1]?.url) || ''
          };
        }).filter(Boolean);
      }

      async function playPlaylist(uri){
        setActivePlaylist(uri);
        const id = uri.split(':').pop();
        tracks = await fetchTracks(id);
        custom = tracks.slice();
        renderTracks(custom);

        await ensureActiveDevice();
        const token = await getToken(); if (!token) return;
        const uris = custom.map(t => t.uri);
        await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
          method:'PUT',
          headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
          body: JSON.stringify({ uris, offset:{ position:0 }, position_ms:0 })
        });
      }

      async function playByIndex(idx){
        if (!custom || idx < 0 || idx >= custom.length) return;
        curIndex = idx;
        await ensureActiveDevice();
        const token = await getToken(); if (!token) return;
        const uris = custom.map(t => t.uri);
        await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
          method:'PUT',
          headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
          body: JSON.stringify({ uris, offset:{ position: idx }, position_ms:0 })
        });
      }

      async function loadPlaylists() {
        const token = await getValidToken(); if (!token) return;

        const res = await fetch("https://api.spotify.com/v1/me/playlists", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) {
          const err = await res.json().catch(()=>({}));
          console.error('Playlists error', res.status, err);
          document.getElementById('tracks-hint').textContent =
            'Ne mogu uƒçitati playliste (provjeri dopu≈°tenja aplikacije na Spotifyju).';
          return;
        }

        const data = await res.json();
        const items = (data.items||[]).sort((a,b)=> a.name.localeCompare(b.name,'hr',{sensitivity:'base'}));
        renderPlaylists(items);
        if (items.length){
          // Prefetch prve (bez automatske reprodukcije)
          const firstTracks = await fetchTracks(items[0].id);
          tracks = firstTracks; custom = tracks.slice(); renderTracks(custom);
          setActivePlaylist(items[0].uri);
        }
      }


      // Public (poziva Radio):
      function pauseQuiet(){ try { player?.pause(); } catch(_) {} }

      // SDK READY
      window.onSpotifyWebPlaybackSDKReady = async () => {
        const token = await getToken(); if (!token) return;

        player = new Spotify.Player({
          name: 'Lerone Web Player',
          getOAuthToken: async cb => { cb(await getToken() || await refreshAccessToken()); },
          volume: 0.5
        });

        player.addListener('ready', async ({ device_id }) => {
          deviceId = device_id; ready = true;
          playBtn.disabled = false;
          try { player.setVolume(vol.valueAsNumber); } catch(_) {}
          await ensureActiveDevice();
          loadPlaylists();

          playBtn.addEventListener('click', async () => {
            if (!ready || lock) return;
            lock = true; setTimeout(()=>lock=false, 320);

            // ugasi radio
            Radio.pause();

            const st = await player.getCurrentState();
            const empty = !st || !st.track_window || !st.track_window.current_track;
            if (empty){
              await ensureActiveDevice();
              if (custom?.length) await playByIndex(curIndex >= 0 ? curIndex : 0);
              else if (playlists[0]?.uri) await playPlaylist(playlists[0].uri);
            } else {
              player.togglePlay();
            }
          });
        });

        player.addListener('player_state_changed', (state) => {
          if (!state) return;
          setBtn(playBtn, !state.paused);

          // kad Spotify svira, ugasi radio
          if (!state.paused) Radio.pause();

          const cur = state.track_window?.current_track;
          if (cur){
            $('#sp-track').textContent = cur.name;
            $('#sp-artist').textContent = (cur.artists||[]).map(a=>a.name).join(', ');
            $('#sp-img').src = cur.album?.images?.[0]?.url || '';
            curUri = cur.uri;
            nowEl.textContent = `Sada svira: ${cur.name} ‚Äî ${(cur.artists||[]).map(a=>a.name).join(', ')}`;
            if (custom){
              const i = custom.findIndex(t => t.uri === cur.uri);
              if (i !== -1) curIndex = i;
            }
            highlight(cur.uri);
          }
        });

        player.addListener('authentication_error', ({message}) => console.warn('auth_error', message));
        player.addListener('account_error',        ({message}) => console.warn('account_error', message));
        player.addListener('initialization_error', ({message}) => console.warn('init_error', message));
        player.addListener('playback_error',       ({message}) => console.warn('playback_error', message));

        player.connect();
      };

      // Volume UI
      vol.addEventListener('input', () => {
        try { player?.setVolume(vol.valueAsNumber); } catch(_) {}
        vlbl.textContent = pct(vol.valueAsNumber);
      });

      return { pauseQuiet };
    })();

    /*************************************************
     * BOOT
     *************************************************/
    (function init(){
      // Radio
      Radio.init();
      // Spotify volume label
      $('#sp-vlbl').textContent = pct($('#sp-vol').valueAsNumber);
      // SDK ƒáe sam pozvati window.onSpotifyWebPlaybackSDKReady
    })();
  </script>
</body>
</html>
