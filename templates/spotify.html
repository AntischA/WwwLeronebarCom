<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>Spotify + 3 Radio Playera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0b1020;
      --card:#11182a;
      --soft:#0f1526;
      --text:#e8eef7;
      --sub:#a7b2c6;
      --accent:#10b981;
      --accent-2:#1db954;
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --gap:18px;
      --gap-lg:22px;
      --active-1:#16324a;
      --active-2:#0f1f39;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 30% -10%, #17213f 0%, #0b1020 55%, #0b1020 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    }

    /* Stranica visine prozora; drugi red puni ostatak */
    .page{
      max-width:1280px;
      margin:0 auto;
      padding:22px var(--gap);
      display:grid;
      grid-template-rows:auto 1fr;
      gap:var(--gap-lg);
      height: 100dvh;
      min-height: 100svh;
    }

    .btn{
      appearance:none; border:0; cursor:pointer;
      background:var(--accent-2); color:#062d16;
      padding:20px 16px; border-radius:12px; font-weight:800;
      transition:transform .06s ease, filter .12s ease;
    }
    .btn:active{ transform:translateY(1px) }
    .btn.alt{ background:var(--accent); color:#04281f }

    /* Red 1: 3 kartice */
    .radios-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:var(--gap-lg);
    }
    .radio-card{
      background:linear-gradient(180deg, var(--card), var(--soft));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex; flex-direction:column; gap:10px;
      min-height:160px;
      transition: background .2s ease, outline-color .2s ease, box-shadow .2s ease;
      outline:2px solid transparent;
    }
    .radio-card.is-active{
      background:linear-gradient(180deg, var(--active-1), var(--active-2));
      outline-color: var(--accent);
      box-shadow:0 12px 34px rgba(16,185,129,.25);
    }

    .radio-head{ display:flex; align-items:center; gap:10px; }
    .radio-title{ font-weight:800; letter-spacing:.2px; font-size:1.02rem; }
    .radio-status{ margin-left:auto; font-size:.9rem; color:var(--sub); }

    .radio-controls{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .vol{ display:flex; align-items:center; gap:8px; color:var(--sub); font-size:.9rem; }
    .vol input[type="range"]{ width:180px; }

    .ticker{
      overflow:hidden; white-space:nowrap;
      -webkit-mask-image:linear-gradient(90deg,transparent 0,#000 8%,#000 92%,transparent 100%);
      mask-image:linear-gradient(90deg,transparent 0,#000 8%,#000 92%,transparent 100%);
      font-size:.95rem; color:#dfe8f7;
    }
    .ticker span{ display:inline-block; padding-left:100%; animation:ticker 12s linear infinite; }
    @keyframes ticker{ from{ transform:translateX(0);} to{ transform:translateX(-100%);} }

    /* Red 2 */
    .content-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:var(--gap-lg);
      align-items:stretch;
      min-height:0;
    }

    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex; flex-direction:column;
      height:100%;
      min-height:0;
      overflow:hidden;
    }
    .panel h3{
      margin:0 0 10px 0; font-size:1.02rem; letter-spacing:.2px;
      position:sticky; top:0; background:var(--card); z-index:1; padding-bottom:8px;
    }

    .list{
      list-style:none; margin:0; padding:0;
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
    }
    .list li{
      background:#17213b; margin:8px 0; padding:10px 12px; border-radius:10px;
      cursor:pointer; transition:filter .12s ease, transform .06s ease;
    }
    .list li:hover{ filter:brightness(1.07); transform:translateY(-1px); }

    .track-item{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; }
    .track-item:hover{ background:#1a2747; }
    .track-thumb{ width:44px;height:44px;border-radius:6px;object-fit:cover;background:#24345e;flex:0 0 44px; }
    .track-text{ min-width:0; }
    .track-title{ font-weight:700; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .track-artist{ color:var(--sub); font-size:.82rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .track-item.playing{ outline:1px solid #3a7bd5; background:#15294f; }

    .sr-only{ display:none !important; }

    @media (max-width: 1100px){
      .radios-grid{ grid-template-columns: repeat(2,1fr); }
      .content-grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 800px){
      .radios-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="page">

    <!-- RED 1: Radio Dalmacija + Naxi + Spotify -->
    <section class="radios-grid">

      <article class="radio-card" id="rd-card">
        <div class="radio-head">
          <div class="radio-title">üéß Radio Dalmacija ‚Äî Live</div>
          <div id="rd-status" class="radio-status">Spremno</div>
        </div>
        <div class="radio-controls">
          <button id="rd-play" class="btn alt">‚ñ∂ Play</button>
          <div class="vol">
            <span>Glasnoƒáa</span>
            <input id="rd-vol" type="range" min="0" max="1" step="0.01" value="0.9">
          </div>
        </div>
        <div class="ticker"><span id="rd-now">Spajam se na Radio Dalmaciju‚Ä¶</span></div>
        <audio id="rd-audio" preload="none">
          <source src="https://shoutcast.pondi.hr:9000/;" type="audio/aac">
        </audio>
      </article>

      <article class="radio-card" id="nx-card">
        <div class="radio-head">
          <div class="radio-title">üìª Naxi Radio ‚Äî Live</div>
          <div id="nx-status" class="radio-status">Spremno</div>
        </div>
        <div class="radio-controls">
          <button id="nx-play" class="btn alt">‚ñ∂ Play</button>
          <div class="vol">
            <span>Glasnoƒáa</span>
            <input id="nx-vol" type="range" min="0" max="1" step="0.01" value="0.9">
          </div>
        </div>
        <div class="ticker"><span id="nx-now">Spajam se na Naxi Radio‚Ä¶</span></div>
        <audio id="nx-audio" preload="none">
          <source src="https://naxi128ssl.streaming.rs:9152/;" type="audio/mpeg">
          <source src="https://naxi64ssl.streaming.rs:9162/;" type="audio/mpeg">
        </audio>
      </article>

      <article class="radio-card" id="sp-card">
        <div class="radio-head">
          <div class="radio-title">üéµ Spotify ‚Äî Player</div>
          <div id="sp-status" class="radio-status">Spremno</div>
        </div>
        <div class="radio-controls">
          <button id="playPause" class="btn alt">‚ñ∂ Play</button>
          <div class="vol">
            <span>Glasnoƒáa</span>
            <input id="sp-vol" type="range" min="0" max="1" step="0.01" value="0.9">
          </div>
        </div>
        <div class="ticker"><span>Odaberi playlistu ispod pa klikni Play.</span></div>

        <div class="sr-only">
          <img id="albumImage" alt="">
          <div id="trackName"></div>
          <div id="artistName"></div>
          <input type="range" id="seekSlider" value="0" min="0" max="100" step="1">
        </div>
      </article>

    </section>

    <!-- RED 2: Playliste (lijevo) i Pjesme (desno) -->
    <section class="content-grid">
      <article class="panel">
        <h3>üìö Moje playliste</h3>
        <ul id="playlistList" class="list"></ul>
      </article>

      <article class="panel">
        <h3>üéº Pjesme u playlisti</h3>
        <ul id="tracksList" class="list"></ul>
      </article>
    </section>
  </div>

  <!-- Spotify SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>
  let player;
  let deviceId = null;
  let currentPlaylistUri = null;
  let currentTracks = [];
  let trackUriToLi = new Map();
  let lastPlayingEl = null;
  let displayedOrder = [];
  let customOrder = null;
  let customIndex = -1;
  let currentTrackUri = null;

  let lastProvidedToken = null;

  /* UI helperi */
  const cards   = { rd: document.getElementById('rd-card'), nx: document.getElementById('nx-card'), sp: document.getElementById('sp-card') };
  const buttons = { rd: document.getElementById('rd-play'), nx: document.getElementById('nx-play'), sp: document.getElementById('playPause') };
  const audios  = { rd: document.getElementById('rd-audio'), nx: document.getElementById('nx-audio') };

  function setButtonLabel(btn, playing){ btn.textContent = playing ? '‚è∏ Pause' : '‚ñ∂ Play'; }
  function setActiveCard(name){ Object.keys(cards).forEach(k => cards[k].classList.toggle('is-active', k === name)); }
  function pauseAllRadios(){
    Object.values(audios).forEach(a => { try{ a.pause(); }catch(e){} });
    setButtonLabel(buttons.rd, false);
    setButtonLabel(buttons.nx, false);
  }
  function anyRadioPlaying(){ return Object.values(audios).some(a => !a.paused && !a.ended); }

  /* ============= SPOTIFY ============= */
  window.onSpotifyWebPlaybackSDKReady = async () => {
    const token = await getValidToken();
    if (!token) return;

    player = new Spotify.Player({
      name: 'Lerone Web Player',
      getOAuthToken: async (cb) => {
        try {
          let t = await getValidToken();
          if (!t || t === lastProvidedToken) t = await refreshAccessToken();
          lastProvidedToken = t;
          cb(t);
        } catch (e) { console.error('getOAuthToken error', e); }
      },
      volume: 0.5
    });

    player.addListener('ready', ({ device_id }) => {
      deviceId = device_id;
      const spVol = document.getElementById('sp-vol');
      if (spVol) { try { player.setVolume(spVol.valueAsNumber); } catch(e) {} }
      loadPlaylists(); // samo uƒçitaj & izmije≈°aj ‚Äì bez autoplay
    });

    player.addListener('authentication_error', ({message}) => console.warn('auth_error', message));
    player.addListener('account_error',        ({message}) => console.warn('account_error', message));
    player.addListener('initialization_error', ({message}) => console.warn('init_error', message));
    player.addListener('playback_error',       ({message}) => console.warn('playback_error', message));

    player.addListener('player_state_changed', state => {
      if (!state) return;

      const paused = state.paused;
      setButtonLabel(buttons.sp, !paused);

      if (!paused){
        pauseAllRadios();
        setActiveCard('sp');
      }else{
        if (!anyRadioPlaying()) setActiveCard(null);
      }

      const current = state.track_window.current_track;
      if (current){
        document.getElementById("trackName").textContent = current.name;
        document.getElementById("artistName").textContent = current.artists.map(a => a.name).join(", ");
        document.getElementById("albumImage").src = current.album.images[0]?.url || '';
        currentTrackUri = current.uri;
        if (customOrder) {
          const idx = customOrder.findIndex(t => t.uri === current.uri);
          if (idx !== -1) customIndex = idx;
        }
        highlightAndCenterCurrentTrack(current.uri);
      }
    });

    player.connect();
  };

  function playPlaylist(uri, autoPlay = false) {
    currentPlaylistUri = uri;
    const playlistId = uri.split(':').pop();

    getValidToken().then(async token => {
      // Klik na playlistu -> pokreni sviranje te playliste odmah
      await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ context_uri: uri })
      });

      if (autoPlay) {
        // ako nakon kratkog ƒçekanja i dalje stoji pauza -> pokreni
        setTimeout(async () => {
          const st = await player.getCurrentState();
          if (st && st.paused) player.togglePlay();
        }, 800);
      }

      loadPlaylistTracks(playlistId);
    });
  }

  async function loadPlaylistTracks(playlistId) {
    const token = await getValidToken();
    if (!token) return;

    let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;
    let items = [];

    while (url) {
      const res = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
      const data = await res.json();
      if (!data || !data.items) break;
      items = items.concat(data.items);
      url = data.next;
    }

    currentTracks = items.map((it, idx) => {
      const t = it.track; if (!t) return null;
      return {
        name: t.name,
        artists: (t.artists || []).map(a => a.name).join(", "),
        uri: t.uri,
        albumImage: (t.album && t.album.images && t.album.images.length)
          ? t.album.images[t.album.images.length - 1].url : "",
        originalIndex: idx
      };
    }).filter(Boolean);

    // auto shuffle
    shuffleTrackList();
  }

  function renderTracks(tracksArray) {
    displayedOrder = tracksArray.slice();
    const listEl = document.getElementById("tracksList");
    listEl.innerHTML = "";
    trackUriToLi.clear();

    displayedOrder.forEach((item, idx) => {
      const li = document.createElement("li");
      li.className = "track-item";

      const img = document.createElement("img");
      img.src = item.albumImage || "";
      img.alt = "Cover";
      img.className = "track-thumb";

      const textWrap = document.createElement("div");
      textWrap.className = "track-text";
      const title = document.createElement("div");
      title.className = "track-title";
      title.textContent = item.name;
      const artist = document.createElement("div");
      artist.className = "track-artist";
      artist.textContent = item.artists;

      textWrap.appendChild(title);
      textWrap.appendChild(artist);
      li.appendChild(img);
      li.appendChild(textWrap);

      li.onclick = () => {
        customOrder = displayedOrder.slice();
        playByCustomIndex(idx);
      };

      if (item.uri === currentTrackUri) {
        li.classList.add("playing");
        lastPlayingEl = li;
      }

      listEl.appendChild(li);
      trackUriToLi.set(item.uri, li);
    });
  }

  async function playByCustomIndex(index) {
    if (!customOrder || index < 0 || index >= customOrder.length) return;
    const uris = customOrder.map(t => t.uri);
    customIndex = index;

    const token = await getValidToken();
    if (!token) return;

    await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
      body: JSON.stringify({ uris, offset: { position: index }, position_ms: 0 })
    });
  }

  function shuffleTrackList() {
    const copy = currentTracks.slice();
    for (let i = copy.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }

    renderTracks(copy);
    customOrder = copy.slice();

    const idx = customOrder.findIndex(t => t.uri === currentTrackUri);
    customIndex = (idx !== -1) ? idx : 0;

    if (currentTrackUri) {
      requestAnimationFrame(() => {
        highlightAndCenterCurrentTrack(currentTrackUri);
      });
    }

    applyCustomQueueAtCurrentTrack({ preservePosition: true });
  }

  async function applyCustomQueueAtCurrentTrack({ preservePosition = true } = {}) {
    if (!customOrder || customIndex < 0) return;

    const token = await getValidToken();
    if (!token) return;

    const uris = customOrder.map(t => t.uri);

    let position_ms = 0;
    if (preservePosition && player) {
      const st = await player.getCurrentState();
      if (st) position_ms = st.position || 0;
    }

    await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
      body: JSON.stringify({ uris, offset: { position: customIndex }, position_ms })
    });
  }

  function highlightAndCenterCurrentTrack(trackUri) {
    if (!trackUriToLi.has(trackUri)) return;
    if (lastPlayingEl) lastPlayingEl.classList.remove("playing");
    const el = trackUriToLi.get(trackUri);
    el.classList.add("playing");
    lastPlayingEl = el;
    el.scrollIntoView({ block: "center", behavior: "smooth" });
  }

  function togglePlay() { if (!player) return; player.togglePlay(); }

  async function refreshAccessToken() {
    const refreshToken = localStorage.getItem("refresh_token");
    if (!refreshToken) { window.location.href = "/spotify_auth"; return null; }

    const res = await fetch("/refresh_token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: refreshToken })
    });
    const data = await res.json();

    if (res.ok && data.access_token) {
      localStorage.setItem("access_token", data.access_token);
      localStorage.setItem("token_timestamp", Date.now());
      return data.access_token;
    } else {
      console.error("Refresh failed", data);
      return null;
    }
  }

  async function getValidToken() {
    const accessToken = localStorage.getItem("access_token");
    const refreshToken = localStorage.getItem("refresh_token");
    if (!refreshToken) { window.location.href = "/spotify_auth"; return null; }

    const ts = parseInt(localStorage.getItem("token_timestamp") || "0", 10);
    const maxAge = 55 * 60 * 1000;

    if (!accessToken || (Date.now() - ts) >= maxAge) {
      return await refreshAccessToken();
    }
    return accessToken;
  }

  async function loadPlaylists() {
    const token = await getValidToken();
    if (!token) return;

    const res = await fetch("https://api.spotify.com/v1/me/playlists", {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await res.json();
    const list = document.getElementById("playlistList");
    list.innerHTML = "";

    const sortedPlaylists = data.items.sort((a, b) =>
      a.name.localeCompare(b.name, 'hr', { sensitivity: 'base' })
    );

    let firstPlaylistUri = null;

    sortedPlaylists.forEach((pl, index) => {
      const li = document.createElement("li");
      li.textContent = pl.name;
      li.style.cursor = "pointer";
      li.onclick = () => playPlaylist(pl.uri); // klik pokreƒáe sviranje
      list.appendChild(li);
      if (index === 0) firstPlaylistUri = pl.uri;
    });

    // ‚¨áÔ∏è Samo uƒçitaj i izmije≈°aj prvu ‚Äì BEZ automatskog sviranja
    if (firstPlaylistUri) {
      currentPlaylistUri = firstPlaylistUri;
      const firstPlaylistId = firstPlaylistUri.split(':').pop();
      await loadPlaylistTracks(firstPlaylistId);
    }
  }
  </script>

  <!-- Radio logika -->
  <script>
    const allRadios = [];

    function makeRadio({ audioId, playId, volId, statusId, nowId, label }) {
      const a  = document.getElementById(audioId);
      const b  = document.getElementById(playId);
      const vr = document.getElementById(volId);
      const st = document.getElementById(statusId);
      const nw = document.getElementById(nowId);
      const cardKey = (label||'').toLowerCase(); // 'rd' | 'nx'

      allRadios.push(a);

      let retries = 0, maxRetries = 5;
      const setStatus = t => st.textContent = t;
      const setNow    = t => nw.textContent = t;

      async function playOnlyThis() {
        try {
          Object.values(audios).forEach(x => { if (x !== a) x.pause(); });
          if (window.player && player.pause) await player.pause();
          setButtonLabel(buttons.sp, false);

          setStatus('Poku≈°avam reproducirati‚Ä¶');
          await a.play();
          setButtonLabel(b, true);
          setActiveCard(cardKey);
        } catch (e) {
          setStatus('Klikni ‚ÄúPlay‚Äù (autoplay blokiran).');
          console.warn(`[${label}] play error`, e);
        }
      }

      function reconnect() {
        if (retries < maxRetries) {
          retries++;
          const delay = Math.min(1500 * retries, 7000);
          setTimeout(() => { a.load(); a.play().catch(()=>{}); }, delay);
        } else {
          setStatus('Ne mo≈æe se spojiti. Provjeri stream URL.');
        }
      }

      b.addEventListener('click', () => {
        if (a.paused) playOnlyThis(); else a.pause();
      });

      vr && vr.addEventListener('input', () => { a.volume = vr.valueAsNumber; });

      a.addEventListener('error',   () => { setStatus('Gre≈°ka na streamu. Poku≈°avam ponovo‚Ä¶'); reconnect(); });
      a.addEventListener('stalled', () => { setStatus('Veza je zastala‚Ä¶ poku≈°avam ponovo.');   reconnect(); });

      a.addEventListener('playing', () => {
        retries = 0;
        setStatus('Reproduciram ‚úÖ');
        setNow('Sviramo najbolje hitove üéµ');
        setButtonLabel(b, true);
        setActiveCard(cardKey);
        if (window.player && player.pause) player.pause();
        Object.values(audios).forEach(x => { if (x !== a) x.pause(); });
        if (b === buttons.rd) setButtonLabel(buttons.nx, false);
        if (b === buttons.nx) setButtonLabel(buttons.rd, false);
        setButtonLabel(buttons.sp, false);
      });

      a.addEventListener('pause', () => {
        setButtonLabel(b, false);
        const otherRadioPlaying = Object.values(audios).some(x => x !== a && !x.paused && !x.ended);
        const checkSpotify = (window.player && player.getCurrentState) ? player.getCurrentState() : null;
        Promise.resolve(checkSpotify).then(st => {
          const spIsPlaying = st ? !st.paused : false;
          if (!otherRadioPlaying && !spIsPlaying) setActiveCard(null);
        });
      });

      a.addEventListener('ended', () => {
        setButtonLabel(b, false);
        const radioJosSvira = Object.values(audios).some(x => !x.paused && !x.ended);
        Promise.resolve(player?.getCurrentState?.()).then(st => {
          const spIsPlaying = st ? !st.paused : false;
          if (!radioJosSvira && !spIsPlaying) setActiveCard(null);
        });
      });

      return { playOnlyThis, setStatus, setNow, audio:a, button:b };
    }

    const RD = makeRadio({ audioId:'rd-audio', playId:'rd-play', volId:'rd-vol', statusId:'rd-status', nowId:'rd-now', label:'rd' });
    const NX = makeRadio({ audioId:'nx-audio', playId:'nx-play', volId:'nx-vol', statusId:'nx-status', nowId:'nx-now', label:'nx' });

    // Spotify Play:
    // - ugasi radije
    // - ako jo≈° ni≈°ta nije uƒçitano u player (nema current tracka), pusti 1. iz customOrder
    // - inaƒçe togglaj play/pause
    document.getElementById('playPause').addEventListener('click', async () => {
      pauseAllRadios();

      const st = await player.getCurrentState();
      const nothingLoaded = !st || !st.track_window || !st.track_window.current_track;

      if (nothingLoaded && customOrder && customOrder.length) {
        await playByCustomIndex(customIndex >= 0 ? customIndex : 0);
      } else {
        togglePlay();
      }
    });

    // Spotify glasnoƒáa (0‚Äì1), identiƒçno kao na radijima
    const spVol = document.getElementById('sp-vol');
    if (spVol) {
      spVol.addEventListener('input', () => {
        if (window.player && player.setVolume) {
          player.setVolume(spVol.valueAsNumber);
        }
      });
    }
  </script>
</body>
</html>
